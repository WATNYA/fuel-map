<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>خريطة محطات الوقود مع أوامر ذكية + بحث صوتي</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f4f4f4;display:flex;flex-direction:column;height:100vh}
    header{background:#007BFF;color:#fff;padding:1rem;text-align:center;font-size:1.5rem;flex-shrink:0}
    #container{display:flex;flex:1;overflow:hidden}
    #sidebar{width:250px;background:#fff;border-left:1px solid #ddd;overflow-y:auto;padding:0.5rem}
    #sidebar h2{font-size:1.2rem;margin-bottom:0.5rem}
    #sidebar ul{list-style:none;padding:0;margin:0}
    #sidebar li{padding:0.5rem;cursor:pointer;border-bottom:1px solid #eee}
    #sidebar li:hover{background:#f0f0f0}
    #map{flex:1 1 auto}
    #infoBar{background:#007BFF;color:#fff;padding:0.5rem;text-align:center;flex-shrink:0}

    #assistant{position:fixed;bottom:10px;left:10px;width:320px;max-width:92%;background:#fff;border:1px solid #ccc;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1)}
    #assistant h3{background:#007BFF;color:#fff;padding:0.5rem;margin:0;border-top-left-radius:8px;border-top-right-radius:8px}
    #assistant #messages{height:160px;overflow-y:auto;padding:0.5rem;border-bottom:1px solid #ddd;font-size:0.9rem}
    #assistant #input{display:flex;padding:0.5rem;gap:0.5rem;align-items:center}
    #assistant input{flex:1;padding:0.4rem;border:1px solid #ccc;border-radius:4px}
    #assistant button{padding:0.4rem 0.6rem;background:#007BFF;color:#fff;border:none;border-radius:4px;cursor:pointer}
    #micBtn{background:#eee;color:#333;border:1px solid #ccc}
    #micBtn.listening{background:#ffebee;border-color:#f44336;color:#b71c1c}

    .clickable-station{color:darkgreen;cursor:pointer;text-decoration:underline}

    @media (max-width: 768px){
      #container{flex-direction:column}
      #sidebar{width:100%;max-height:200px;border-left:none;border-top:1px solid #ddd}
      #assistant{left:50%;transform:translateX(-50%);bottom:10px;width:95%;max-width:360px}
    }
  </style>
  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
</head>
<body>

  <header>خريطة محطات الوقود</header>

  <div id="container">
    <div id="sidebar">
      <h2>المحطات</h2>
      <ul id="stationList"></ul>
    </div>
    <div id="map"></div>
  </div>

  <div id="infoBar">اختر محطة لرؤية اسمها هنا</div>

  <div id="assistant">
    <h3>مساعد المحطات</h3>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="userInput" placeholder="اكتب أو انطق: 'أقرب محطة' أو اسم المحطة...">
      <button id="micBtn" title="بحث صوتي 🎤">🎤</button>
      <button id="sendBtn">إرسال</button>
    </div>
  </div>

  <script>
    // ======== بيانات المحطات ========
    const stations = [
      // TODO: ألصق مصفوفة المحطات هنا كما هي من كودك الأصلي (جميع العناصر {name, lat, lon})
      // مثال صغير للتجربة السريعة (احذف المثالين عند لصق قائمتك):
      { name: 'رئاسة الشركة', lat: 30.075775, lon: 31.31986388888889 },
  { name: 'مستودع وطنية', lat: 30.10302222222222, lon: 31.81430833333333 },
  { name: 'جراج فرع النقل', lat: 30.101125, lon: 31.81966111111111 },
  { name: 'مركز الصيانة', lat: 30.07979166666666, lon: 31.38048611111111 },
  { name: 'المقطم', lat: 29.98694824132808, lon: 31.30985320769065 },
  { name: 'رئاسة الشركة', lat: 30.075775, lon: 31.31986388888889 },
      { name: 'مستودع وطنية', lat: 30.10302222222222, lon: 31.81430833333333 },
      { name: 'جراج فرع النقل', lat: 30.101125, lon: 31.81966111111111 },
      { name: 'مركز الصيانة', lat: 30.07979166666666, lon: 31.38048611111111 },
      { name: 'المقطم', lat: 29.98694824132808, lon: 31.30985320769065 },
      { name: 'الاوسطى 1', lat: 30.28626388984991, lon: 31.49291944442958 },
      { name: 'الاوسطى 2', lat: 30.15523588502526, lon: 31.5907861217966 },
      { name: 'الواحة', lat: 30.04382807658138, lon: 31.3814586417349 },
      { name: 'الرحاب', lat: 30.04365008035782, lon: 31.49653604012123 },
      { name: 'القرنفل', lat: 30.06447015793381, lon: 31.53928923764602 },
      { name: 'بئر جندالى 1', lat: 30.0903877066298, lon: 31.79827368822358 },
      { name: 'جوزيف تيتو', lat: 30.13858748564648, lon: 31.4241203559706 },
      { name: 'ألماظة 1', lat: 30.07960316161521, lon: 31.37995835485073 },
      { name: 'عمر بن الخطاب', lat: 30.07582989257441, lon: 31.34755307770192 },
      { name: 'خلف أكاديمية الشرطة', lat: 30.0494630429643, lon: 31.44170636619374 },
      { name: 'السلام', lat: 30.14640697441456, lon: 31.41385696572434 },
      { name: 'جسر السويس', lat: 30.13008037425697, lon: 31.36940336971842 },
      { name: 'الشروق', lat: 30.18086401557906, lon: 31.60520328849058 },
      { name: 'شيراتون', lat: 30.09103286842517, lon: 31.38015083057827 },
      { name: 'الشاذلي 1', lat: 30.13867423692222, lon: 31.46471226414372 },
      { name: 'الشاذلي 2', lat: 30.13969775299275, lon: 31.46378826512054 },
      { name: 'زهراء مدينة نصر', lat: 30.0511265392261, lon: 31.40308160333856 },
      { name: 'الميثاق', lat: 30.05136265794662, lon: 31.3971085774306 },
      { name: 'محور الشهيد', lat: 30.02971002233712, lon: 31.34063954904504 },
      { name: 'الجبل الأحمر', lat: 30.02215850248961, lon: 31.34294190379184 },
      { name: 'NA', lat: 30.0242189064999, lon: 31.35473472447477 },
      { name: 'محور المشير', lat: 30.01704806318153, lon: 31.38952222222222 },
      { name: 'إمتداد رمسيس', lat: 30.06252381682631, lon: 31.29925720550487 },
      { name: 'شرق المقر العام', lat: 30.07503364278804, lon: 31.33114327983581 },
      { name: 'العبور 3', lat: 30.25416528720834, lon: 31.50075010177336 },
      { name: 'الوفاء والأمل', lat: 30.04590326630239, lon: 31.35472702482853 },
      { name: 'تقاطع مدق 12', lat: 30.17582326843055, lon: 31.74073544515174 },
      { name: 'بئر جندالى 2', lat: 30.08221546624539, lon: 31.79191937860186 },
      { name: 'بلبيس', lat: 30.15329444444444, lon: 31.42863611111111 },
      { name: 'الفردوس 2', lat: 30.06134166666667, lon: 31.36281796715145 },
      { name: 'العاصمة الادارية 1', lat: 30.01370202981815, lon: 31.6043729019069 },
      { name: 'العاصمة الادارية 2', lat: 30.02027261375165, lon: 31.63443276025782 },
      { name: 'العاصمة الادارية 3', lat: 30.00702081746843, lon: 31.64111502776746 },
      { name: 'العاصمة الادارية 4', lat: 30.00725688736835, lon: 31.67266886291217 },
      { name: 'العاصمة الادارية 6', lat: 30.02276836326377, lon: 31.66833474864096 },
      { name: 'العاصمة الادارية 7', lat: 29.99787011096881, lon: 31.72957955858072 },
      { name: 'العاصمة الادارية 8', lat: 29.99460063868408, lon: 31.76939783827126 },
      { name: 'منتصف طريق السخنة 2', lat: 29.77664229747725, lon: 31.92004204817029 },
      { name: 'منتصف طريق السخنة 1', lat: 29.77422940589028, lon: 31.91932648571166 },
      { name: 'العبور 2', lat: 30.20333333333333, lon: 31.46416666666667 },
      { name: 'العبور 1', lat: 30.24704166666667, lon: 31.48254721230442 },
      { name: 'بلبيس 2', lat: 30.29833333333334, lon: 31.48611111111111 },
      { name: 'جنوب طريق العين السخنة', lat: 29.86945729999301, lon: 31.68172751403429 },
      { name: 'ج طر العين السخنة 2', lat: 29.87093256197269, lon: 31.6806832036989 },
      { name: 'المستقبل', lat: 30.16413114542686, lon: 31.56333517325951 },
      { name: 'احمد جلال', lat: 30.13555555555556, lon: 31.45508888888889 },
      { name: 'العين السخنة', lat: 29.64111099982135, lon: 32.29571017825832 },
      { name: 'القطامية', lat: 29.97716617603694, lon: 31.35826887304654 },
      { name: 'جنوب طر بلبيس', lat: 30.25083333333333, lon: 31.67055555555556 },
      { name: 'الشروق 3 )ق17(', lat: 30.15088997078775, lon: 31.64506149730763 },
      { name: 'عين الصيرة', lat: 30.01595759821674, lon: 31.25066675898088 },
      { name: 'مدينة الجلود', lat: 30.17515186617001, lon: 31.77100922142075 },
      { name: 'الغابة الشجرية', lat: 30.01655313436398, lon: 31.36659721911641 },
      { name: 'دجلة بالمز', lat: 29.89589369397379, lon: 30.9024646272795 },
      { name: '15 مايو', lat: 29.81335245146682, lon: 31.37035629373099 },
      { name: 'وصلة دهشور الجنوبية', lat: 29.9069792549891, lon: 30.96420028861255 },
      { name: 'الضبعة 2 الكم (23)', lat: 30.15547099354068, lon: 30.43917512794963 },
      { name: 'حدائق أكتوبر', lat: 29.93194966615383, lon: 30.91303330372172 },
      { name: 'الوراق', lat: 30.09524927024232, lon: 31.21710765169971 },
      { name: 'شق الثعبان', lat: 29.93972307880073, lon: 31.33972240979939 },
      { name: 'عين حلوان', lat: 29.86919217223963, lon: 31.30495492029978 },
      { name: 'الياسمين', lat: 29.96892133140294, lon: 30.92250598048771 },
      { name: 'وادي حوف', lat: 29.90309475179743, lon: 31.30942998603453 },
      { name: 'كوم أوشيم', lat: 29.53204624602245, lon: 30.91432501192514 },
      { name: 'الضبعة 1 الكم (2)', lat: 30.14982499973745, lon: 30.65973099975346 },
      { name: 'الضبعة 3 الكم (46)', lat: 30.10999726075029, lon: 30.2218508584071 },
      { name: 'الضبعة 4 الكم (65)', lat: 30.10516609174782, lon: 30.02754769681673 },
      { name: 'وراق الحضر', lat: 30.10059184604648, lon: 31.22237038696614 },
      { name: 'زهراء المعادي 1', lat: 29.97575444570734, lon: 31.29028757583445 },
      { name: 'المعادي', lat: 29.96777133187629, lon: 31.28738168800907 },
      { name: 'زهراء المعادى 3', lat: 29.96977220964788, lon: 31.33503580728113 },
      { name: 'العياط 2', lat: 29.65972222222222, lon: 31.15694444444444 },
      { name: 'الرماية', lat: 29.98014871780505, lon: 31.11603923046794 },
      { name: '6 أكتوبر 1', lat: 29.95797002850875, lon: 31.06360974600241 },
      { name: 'الفردوس 1 البديل', lat: 29.96389459068157, lon: 31.03289444444444 },
      { name: 'الفردوس 1', lat: 29.96185548829188, lon: 31.04143875272345 },
      { name: 'أسيوط الغربي 1', lat: 29.83126287258711, lon: 31.0512003353644 },
      { name: 'أسيوط الغربي 2', lat: 29.81482604209389, lon: 31.05457488710856 },
      { name: 'تقاطع طريق الفيوم', lat: 29.63859030459408, lon: 30.98765133313977 },
      { name: 'بحيرة قارون', lat: 29.57609924593535, lon: 30.77285499708284 },
      { name: 'غرب طريق الصعيد الحر (العياط 1)', lat: 29.65833661588358, lon: 31.15781647156783 },
      { name: 'جنوب طريق الواحات', lat: 29.74941897835804, lon: 30.52637072495616 },
      { name: 'روض الفرج 2', lat: 30.10671205445445, lon: 31.01034882712784 },
      { name: 'روض الفرج 1', lat: 30.10671742586565, lon: 30.99281535389128 },
      { name: 'جنوب محور روض الفرج', lat: 30.05921760054032, lon: 30.6774588622855 },
      { name: '6 أكتوبر 2', lat: 30.0001642697614, lon: 31.0993374704058 },
      { name: 'روض الفرج 3', lat: 30.0682958240023, lon: 30.82021405646928 },
      { name: 'روض الفرج 4', lat: 30.11923365659208, lon: 30.69483653093331 },
      { name: 'زهراء المعادي 2', lat: 29.96751430158873, lon: 31.31274044927323 },
      { name: 'المنطقة الصناعية', lat: 29.92850910596119, lon: 30.8724514053075 },
      { name: 'شرق طر الصعيد الحر', lat: 29.74333333333333, lon: 31.43666666666667 },
      { name: 'شرق طر الصعيد الحر 2', lat: 29.7425, lon: 31.43888888888889 },
      { name: 'الهندسية للسيارات', lat: 29.88276865924715, lon: 31.31287999459341 },
      { name: 'ج محور روض الفرج 2', lat: 30.05126728392293, lon: 30.68019400013581 },
      { name: 'برج العرب 4', lat: 30.88224166666667, lon: 29.55656666666667 },
      { name: 'المحمودية 3 (مدرسة ناصر)', lat: 31.17614098635891, lon: 29.89647627209977 },
      { name: 'بشاير الخير', lat: 31.16038642163144, lon: 29.88759143273438 },
      { name: 'علم الروم', lat: 31.3551658635391, lon: 27.27195592618921 },
      { name: 'برج العرب 2', lat: 30.84764326202319, lon: 29.59235457918879 },
      { name: 'برج العرب 3', lat: 30.93209831444963, lon: 29.64011399008592 },
      { name: 'السادات 2', lat: 30.41981268414077, lon: 30.59499997212303 },
      { name: 'السادات 3', lat: 30.33321183381061, lon: 30.52647742953697 },
      { name: 'المحمودية  1 (الشهداء)', lat: 31.19996463997309, lon: 29.94791024670532 },
      { name: 'المحمودية  2 (الكنيسة)', lat: 31.22219039466851, lon: 29.97087333378437 },
      { name: 'العلمين 2', lat: 30.84125309373966, lon: 28.90455342308478 },
      { name: 'العلمين 1', lat: 30.88597222278824, lon: 28.86136111002373 },
      { name: 'العلمين 4', lat: 30.79239722222223, lon: 28.85096316665952 },
      { name: 'العلمين 3', lat: 30.8675, lon: 28.76861111111111 },
      { name: 'البريجات', lat: 30.465, lon: 30.48833333333333 },
      { name: 'سيوة', lat: 29.26482943203803, lon: 25.52364192696968 },
      { name: 'كم 15', lat: 31.26106264529681, lon: 27.11886035985758 },
      { name: 'كم 150سيوة مطروح', lat: 30.25861111111111, lon: 26.25305555555556 },
      { name: 'كم 122', lat: 30.48444444444445, lon: 30.26166666666667 },
      { name: 'المنصورة 2', lat: 31.03471320902531, lon: 31.38116628567716 },
      { name: 'الضبعة  9 الكم (195)', lat: 30.50434287126267, lon: 28.83669784265317 },
      { name: 'الضبعة 5 الكم (92)', lat: 30.21662045352623, lon: 29.79164541120175 },
      { name: 'بنها', lat: 30.44370615912577, lon: 31.17264281339105 },
      { name: 'قويسنا', lat: 30.55696412509658, lon: 31.13571675654221 },
      { name: 'الزقازيق 1', lat: 30.56903390622089, lon: 31.51046733096812 },
      { name: 'الزقازيق 2', lat: 30.57448767921072, lon: 31.51262431326947 },
      { name: 'المنصورة 1', lat: 31.02314885940743, lon: 31.39403502162593 },
      { name: 'كفر الشيخ', lat: 31.11620234337286, lon: 30.94019593586257 },
      { name: 'كفر سعد', lat: 31.3485820822928, lon: 31.68333925777338 },
      { name: 'البرلس الساحلي', lat: 31.57588611111111, lon: 30.96754444444444 },
      { name: 'شطا 1', lat: 31.39331359112804, lon: 31.927012385098 },
      { name: 'شطا 2', lat: 31.39218918240431, lon: 31.92633100230259 },
      { name: 'جنوب العلمين', lat: 30.77051832404611, lon: 28.99130442539109 },
      { name: 'جمصة', lat: 31.43755622812705, lon: 31.50959961838467 },
      { name: 'ادكو', lat: 31.31263381131332, lon: 30.28060984323165 },
      { name: 'كم  106 مطروح', lat: 31.05833333333334, lon: 28.21472222222222 },
      { name: 'موبيل العلمين', lat: 30.84465311401178, lon: 28.94063829448091 },
      { name: 'النوبارية', lat: 30.62928194544494, lon: 30.12514063515657 },
      { name: 'الكيلو 107', lat: 30.48518875927344, lon: 30.26401946939594 },
      { name: 'مرغم', lat: 31.10674431172354, lon: 29.86981648009027 },
      { name: 'الورديان', lat: 31.16095116578735, lon: 29.85859824289265 },
      { name: 'أبو تلات', lat: 31.06277234427587, lon: 29.71033183317077 },
      { name: 'السادات 1', lat: 30.4116642339118, lon: 30.52916244220501 },
      { name: 'برج العرب', lat: 31.00646101201546, lon: 29.73701289083255 },
      { name: 'سملا', lat: 31.3021263280781, lon: 27.31000975683743 },
      { name: 'الضبعة 6 الكم (126)', lat: 30.44682120485489, lon: 29.53734305367387 },
      { name: 'الضبعة  7 الكم (158)', lat: 30.4854440292835, lon: 29.22880501224142 },
      { name: 'الضبعة  10 الكم (214)', lat: 30.56053596771796, lon: 28.64855560978529 },
      { name: 'البرلس سفن', lat: 31.57998888888889, lon: 30.96804722222222 },
      { name: 'بركة غليون', lat: 31.42739096031503, lon: 30.47311143681265 },
      { name: 'المغرة', lat: 30.27166666666666, lon: 28.54722222222222 },
      { name: 'البرقان', lat: 30.67666666666667, lon: 29.30555555555556 },
      { name: 'البرقان 2', lat: 30.67611111111111, lon: 29.29416666666667 },
      { name: 'بلطيم', lat: 31.55472222222224, lon: 31.08194444444445 },
      { name: 'مست السلوم', lat: 31.53864450934451, lon: 25.16670286176912 },
      { name: 'الضبعة  8 الكم (177)', lat: 30.48416079072113, lon: 29.02323977429483 },
      { name: 'محور التعمير 1', lat: 31.01927442180412, lon: 29.66784494493861 },
      { name: 'محور التعمير 2', lat: 31.0198413145068, lon: 29.67172960847098 },
      { name: 'رأس سدر 1', lat: 29.59069722222222, lon: 32.787825 },
      { name: 'رأس سدر 2', lat: 29.59014166666666, lon: 32.78949166666666 },
      { name: 'قرية التمد', lat: 29.66787115424227, lon: 34.3182033993054 },
      { name: 'شرم الشيخ 3', lat: 27.90471811809309, lon: 34.30133950476755 },
      { name: 'شرم الشيخ 2', lat: 27.90464851585996, lon: 34.30148200831477 },
      { name: 'محطة الطور', lat: 28.23666573881956, lon: 33.64497179915232 },
      { name: 'وادى الفراشات', lat: 30.01778025171504, lon: 32.95167878387905 },
      { name: 'بئر العبد', lat: 31.01359707746079, lon: 33.00839465398671 },
      { name: 'النفق 2', lat: 30.10387399576021, lon: 32.54489538315485 },
      { name: 'النفق 1', lat: 30.10458966813797, lon: 32.54343233464986 },
      { name: 'الرويسات', lat: 30.50317428580525, lon: 32.94203034797344 },
      { name: 'رمانة', lat: 31.0185803981156, lon: 32.66639468489418 },
      { name: 'الكيلو 161', lat: 30.67592662001642, lon: 33.76416011046442 },
      { name: 'ابو رديس 1', lat: 28.83368333333333, lon: 33.22472222222223 },
      { name: 'ابو رديس 2', lat: 28.83259166666667, lon: 33.22528151464877 },
      { name: 'نويبع', lat: 28.97964325752664, lon: 34.64669752869678 },
      { name: 'سانت كاترين', lat: 28.63674307430366, lon: 33.99409721760215 },
      { name: 'صدر الحيطان', lat: 30.04024681434818, lon: 33.19901721811456 },
      { name: 'عيون موسى 2', lat: 29.83375277777778, lon: 32.6706041464615 },
      { name: 'الطور 1', lat: 28.26694444444444, lon: 33.71027777777778 },
      { name: 'الطور 2', lat: 28.26641388888888, lon: 33.7111967211694 },
      { name: 'مست الجراحى الميدانى', lat: 30.20495236538156, lon: 32.60767860118611 },
      { name: 'القيادة الموحدة', lat: 30.20719833691201, lon: 32.61039945718116 },
      { name: 'ابو صويرة', lat: 29.56555555555556, lon: 32.75166666666667 },
      { name: 'ابو زنيمة 1', lat: 29.15555555555556, lon: 33.13944444444444 },
      { name: 'ابو زنيمة 2', lat: 29.15562777777777, lon: 33.13968780620754 },
      { name: 'مفارق فيران 1', lat: 28.69472222222222, lon: 33.34972222222223 },
      { name: 'مفارق فيران 2', lat: 28.69478597581636, lon: 33.35146666666667 },
      { name: 'رأس النقب', lat: 29.65679839152886, lon: 34.68019836126364 },
      { name: 'الإسماعيلية شرق', lat: 30.59463071466632, lon: 32.3687063189094 },
      { name: 'القنطرة شرق', lat: 30.8131153060192, lon: 32.3625281101197 },
      { name: 'نخل', lat: 29.89509206105483, lon: 33.75801694405449 },
      { name: 'عيون موسى 1', lat: 29.83529441167873, lon: 32.66732630338639 },
      { name: 'شرم الشيخ', lat: 27.88277382988215, lon: 34.30167169829937 },
      { name: 'القنطرة شرق 2', lat: 30.88722222222222, lon: 32.36055555555556 },
      { name: 'خشبي', lat: 27.82907518766508, lon: 34.09724182626113 },
      { name: 'راس غارب 2', lat: 27.67795890396996, lon: 33.49274437570197 },
      { name: 'ابو سلطان 2', lat: 30.39626111111111, lon: 32.14519166666667 },
      { name: 'سفاجا', lat: 26.82350185599556, lon: 33.91706078081404 },
      { name: 'كم 53 طر السويس', lat: 30.10176226253521, lon: 31.76842247053942 },
      { name: 'المثلث', lat: 29.98888888888889, lon: 32.53611111111111 },
      { name: 'كمين الاحياء', lat: 27.42483823325726, lon: 33.61372824785084 },
      { name: 'الزعفرانة 2', lat: 29.11110319508303, lon: 32.56565161161462 },
      { name: 'ابو صوير', lat: 30.59005277777778, lon: 32.11896111111111 },
      { name: 'نهاية طر قنا', lat: 26.75583333333333, lon: 33.90583333333333 },
      { name: 'النجدة', lat: 27.24063024237849, lon: 33.79856304620372 },
      { name: 'بورسعيد', lat: 31.24727632887075, lon: 32.29043582935695 },
      { name: 'شرق مدينة بدر', lat: 30.09909677243331, lon: 31.8104814644611 },
      { name: 'رأس غارب', lat: 28.35055829947195, lon: 33.049097868835 },
      { name: 'الغردقة', lat: 27.21605350551227, lon: 33.81752473969971 },
      { name: 'الزعفرانة 1', lat: 29.11173462339841, lon: 32.65640233270452 },
      { name: 'تقاطع طريق الجلالة', lat: 29.68717000011862, lon: 32.18923227506952 },
      { name: 'الجلالة 1', lat: 29.42729336338831, lon: 32.38005302019687 },
      { name: 'الكيلو 86', lat: 30.40787648394539, lon: 32.00194223023171 },
      { name: 'العاشر من رمضان', lat: 30.29489162294932, lon: 31.67858954108155 },
      { name: 'بورسعيد 2', lat: 31.22245517353125, lon: 32.29628120627699 },
      { name: 'الكيلو 76 وادي الملاك', lat: 30.37634684751353, lon: 31.93601479968299 },
      { name: 'أبو سلطان', lat: 30.39838929681633, lon: 32.27079743425504 },
      { name: 'الأدبية', lat: 29.9014880175396, lon: 32.45839437503332 },
      { name: 'مدخل السويس', lat: 29.98535976360399, lon: 32.49951591340821 },
      { name: 'أبو الدرج', lat: 29.47652715855452, lon: 32.43809386483634 },
      { name: 'وادى مالحة 1', lat: 29.30716302315792, lon: 32.46492441692472 },
      { name: 'وادى مالحة 2', lat: 29.34027777777778, lon: 32.47472222222223 },
      { name: 'كم 40', lat: 26.69472222222222, lon: 33.60055555555556 },
      { name: 'كم 68', lat: 30.33708055555556, lon: 31.86174166666667 },
      { name: 'قرية الامل', lat: 30.73194444444445, lon: 32.26027777777778 },
      { name: '36 الحربى', lat: 30.61057907484718, lon: 32.19603353854176 },
      { name: 'فنارة', lat: 30.2750724937322, lon: 32.33415300750774 },
      { name: 'جنيفة 2', lat: 30.18173972506692, lon: 31.72646610036497 },
      { name: 'جنيفة 3', lat: 30.18607554015466, lon: 32.13966116709489 },
      { name: 'جنيفة 4', lat: 30.1864731118734, lon: 32.1397408092726 },
      { name: 'أم قمر 1', lat: 30.0987537589778, lon: 31.97459624692837 },
      { name: 'أم قمر 2', lat: 30.36549109306867, lon: 31.9214746381525 },
      { name: '30 يونيو 6', lat: 30.4056260324847, lon: 32.1591734915475 },
      { name: '30 يونيو 5', lat: 30.41855503576401, lon: 32.13505309277273 },
      { name: '30 يونيو 7', lat: 30.05626065720596, lon: 32.09512432044713 },
      { name: '30 يونيو 8', lat: 30.05647014864199, lon: 32.09697574202471 },
      { name: '30 يونيو 9', lat: 29.75294458493673, lon: 32.24629045094341 },
      { name: 'عز الدين', lat: 30.61527777777778, lon: 32.22638888888889 },
      { name: 'محور 30 يونيو 4', lat: 30.84139325871904, lon: 32.16779180738048 },
      { name: 'محور 30 يونيو 3', lat: 30.84161494660134, lon: 32.16534959982928 },
      { name: 'شرق العوينات', lat: 22.54916666666668, lon: 28.70583333333333 },
      { name: 'اسيوط/الفرافرة2', lat: 27.50775277777778, lon: 30.01852222222222 },
      { name: 'الريان 2', lat: 29.17296836589528, lon: 29.58720462611666 },
      { name: 'الكوامل', lat: 26.46556944444444, lon: 31.67604722222222 },
      { name: 'بنى مزار', lat: 28.49109562798933, lon: 30.56588251473643 },
      { name: 'كم 70 بنى مزار', lat: 28.51861111111111, lon: 29.96222222222222 },
      { name: 'ارمنت', lat: 25.57999854904958, lon: 32.42550795031584 },
      { name: 'قنا/سفاجا 2', lat: 26.25572040180424, lon: 32.77157823556193 },
      { name: 'قنا/سفاجا 1', lat: 26.25855223056939, lon: 32.77948201994583 },
      { name: 'الخارجة', lat: 25.44166666666667, lon: 30.57638888888889 },
      { name: 'باريس', lat: 24.66773392103613, lon: 30.60127073795447 },
      { name: 'العدوة', lat: 28.69821111111111, lon: 30.62785 },
      { name: 'ملوى 1', lat: 27.79477035156741, lon: 31.24895067389858 },
      { name: 'حلوان 1', lat: 29.70817857841001, lon: 31.40901241129139 },
      { name: 'حلوان 2', lat: 29.70790063727287, lon: 31.41008672856267 },
      { name: 'الكريمات 1', lat: 29.30715107578071, lon: 31.28203745777033 },
      { name: 'الكريمات 2', lat: 29.2871313992913, lon: 31.26845051793946 },
      { name: 'بني سويف', lat: 29.00741856533704, lon: 31.15201162647529 },
      { name: 'ديمو 1', lat: 29.26225443050356, lon: 30.93182988327919 },
      { name: 'ديمو 2', lat: 29.26060209946089, lon: 30.93234430815037 },
      { name: 'المنيا 1', lat: 28.14205956346041, lon: 30.96788975185603 },
      { name: 'المنيا 2', lat: 28.14360051364754, lon: 30.96781239568652 },
      { name: 'كوم ابو راضى', lat: 29.34395555555555, lon: 31.10731111111112 },
      { name: 'اسنا', lat: 25.30034166666667, lon: 32.46531030511726 },
      { name: 'قوص', lat: 25.79257305093083, lon: 32.81648419694889 },
      { name: 'كم 112', lat: 26.32527777777778, lon: 30.71944444444444 },
      { name: 'سوهاج/البحر الاحمر 1', lat: 26.65975295770398, lon: 32.72981624635088 },
      { name: 'سوهاج/البحر الاحمر 2', lat: 26.86864166666667, lon: 32.07626162884621 },
      { name: 'جامعة المنيا', lat: 28.12785287164234, lon: 30.73111460672358 },
      { name: 'أسيوط 1', lat: 27.3942701951161, lon: 31.51693482312438 },
      { name: 'أسيوط 2', lat: 27.39447965770059, lon: 31.51608972018696 },
      { name: 'بني غالب', lat: 27.18594737133491, lon: 31.04810470895493 },
      { name: 'حي الكوثر', lat: 26.61333102809406, lon: 31.80814234730203 },
      { name: 'قنا', lat: 26.12741575400678, lon: 32.684610370193 },
      { name: 'تجنيد قنا', lat: 26.17205200172492, lon: 32.73161433851576 },
      { name: 'الوقف', lat: 26.10297694909864, lon: 32.51957104092334 },
      { name: 'نقادة', lat: 25.90987427222169, lon: 32.69436312597259 },
      { name: 'نجع حمادي', lat: 25.95678638057849, lon: 32.30947920908105 },
      { name: 'الفرافرة', lat: 27.07830550469851, lon: 27.97563925800215 },
      { name: 'الداخلة', lat: 25.51332147167429, lon: 29.05001503351504 },
      { name: 'أسوان', lat: 24.06254694910178, lon: 32.883515904195 },
      { name: 'كركر', lat: 23.97087963479096, lon: 32.75943022519811 },
      { name: 'جنوب الفيوم', lat: 29.08360396225832, lon: 30.81911321259764 },
      { name: 'الباويطى', lat: 28.33083772298031, lon: 28.84916697350545 },
      { name: 'القرية الخدمية', lat: 27.08027777777778, lon: 28.18805555555556 },
      { name: 'الشيخ فضل 1', lat: 28.50416666666667, lon: 31.01277777777778 },
      { name: 'الفشن', lat: 28.82972222222222, lon: 30.71694444444444 },
      { name: 'القرنة', lat: 25.7575, lon: 32.63916666666667 },
      { name: 'ملوى 2', lat: 27.78337978488247, lon: 31.2553836122903 },
      { name: 'الشيخ الشاذلى', lat: 24.16972222222222, lon: 34.59722222222222 },
      { name: 'بنى صامت(حماضة)', lat: 28.50865101271599, lon: 30.87539154760925 },
      { name: 'الواحات البحرية', lat: 28.41944444444444, lon: 29.14444444444444 },
      { name: 'اطفيح', lat: 29.38111111111111, lon: 31.31138888888889 },
      { name: 'دير البرشا', lat: 27.74941111111112, lon: 31.0282982702471 },
      { name: 'الريان 1', lat: 29.08444444444444, lon: 30.29277777777778 },
      { name: 'كم 70بنى سويف', lat: 28.97089656655293, lon: 31.96231441039454 },
      { name: 'اسيوط/الفرافرة3', lat: 27.14972222222222, lon: 28.91632777777778 },
      { name: 'الشيخ فضل 2', lat: 28.49166666666667, lon: 31.02194444444444 },
      { name: 'كم 90 الشيخ فضل راس غارب', lat: 28.24362128884598, lon: 31.81190103488441 },
      { name: 'جهينة', lat: 26.43585025710658, lon: 31.45827064627424 },
      { name: 'اسيوط/الفرافرة1', lat: 27.58197222222222, lon: 30.65738611111111 },
      { name: 'مرسى علم', lat: 25.18673671369732, lon: 34.82413984125736 },
  { name: 'شلاتين', lat: 23.11694444444445, lon: 35.53583333333333 }
    ];

    // ======== خريطة جوجل + كلاستر ========
    let map, infoWindow, markers = [];
    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {center:{lat:30.05,lng:31.3}, zoom:10});
      infoWindow = new google.maps.InfoWindow();

      stations.forEach(st => {
        const marker = new google.maps.Marker({ position:{lat:st.lat, lng:st.lon}, title:st.name });
        marker.addListener("click", () => showStationInfo(st));
        markers.push(marker);
        addToSidebar(st, marker);
      });

      new MarkerClusterer(map, markers, {
        imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"
      });
    }

    function showStationInfo(station){
      map.setCenter({lat:station.lat, lng:station.lon});
      map.setZoom(15);
      infoWindow.setContent(`<strong>${station.name}</strong>`);
      infoWindow.setPosition({lat:station.lat, lng:station.lon});
      infoWindow.open(map);
      const mapsLink = `https://www.google.com/maps/search/?api=1&query=${station.lat},${station.lon}`;
      document.getElementById("infoBar").innerHTML = `المحطة: ${station.name} | <a href="${mapsLink}" target="_blank">افتح في Google Maps</a>`;
    }

    function addToSidebar(station, marker){
      const li = document.createElement("li");
      li.textContent = station.name;
      li.onclick = () => { map.setCenter(marker.getPosition()); map.setZoom(15); showStationInfo(station); };
      document.getElementById("stationList").appendChild(li);
    }

    // ======== رسائل المساعد ========
    function appendAssistantMessage(sender, html){
      const box = document.getElementById("messages");
      const div = document.createElement("div");
      div.innerHTML = `<strong>${sender}:</strong> ${html}`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    // ======== حساب المسافة + أقرب محطات ========
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function findNearestStations(userLat, userLon, limit=5){
      return stations
        .map(st => ({...st, distance: haversine(userLat, userLon, st.lat, st.lon)}))
        .sort((a,b) => a.distance - b.distance)
        .slice(0, limit);
    }
    function showNearestStations(){
      if(!navigator.geolocation){
        appendAssistantMessage("المساعد", "المتصفح لا يدعم تحديد الموقع.");
        return;
      }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude: userLat, longitude: userLon} = pos.coords;
        const nearest = findNearestStations(userLat, userLon, 5);

        map.setCenter({lat:userLat, lng:userLon});
        map.setZoom(13);

        new google.maps.Marker({
          position:{lat:userLat, lng:userLon}, map,
          title:"موقعك الحالي",
          icon:{ path:google.maps.SymbolPath.CIRCLE, scale:8, fillColor:"#00f", fillOpacity:0.8, strokeColor:"#fff", strokeWeight:2 }
        });

        let msg = "أقرب المحطات إليك:<br>";
        nearest.forEach(st=>{
          const link = `https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}`;
          msg += `<a class="clickable-station" target="_blank" href="${link}">${st.name}</a> (على بعد ${st.distance.toFixed(2)} كم)<br>`;
        });
        appendAssistantMessage("المساعد", msg);
      }, _=>{
        appendAssistantMessage("المساعد", "تعذر الحصول على موقعك. تأكد من تفعيل GPS.");
      });
    }

    // ======== التطبيع الذكي للأسماء (همزات/تاء مربوطة/ال/أرقام… إلخ) ========
    function normalizeName(text){
      if(!text) return "";

      // إلى حروف صغيرة
      text = text.toLowerCase();

      // أرقام عربية -> لاتينية
      const arNums="٠١٢٣٤٥٦٧٨٩", ltNums="0123456789";
      text = text.replace(/[٠-٩]/g, d => ltNums[arNums.indexOf(d)]);

      // إزالة التشكيل والتطويل
      text = text.replace(/[\u0617-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, ""); // تشكيل
      text = text.replace(/\u0640/g, ""); // تطويل

      // توحيد همزات وأحرف
      text = text
        .replace(/[آأإٱ]/g,"ا")
        .replace(/ة/g,"ه")
        .replace(/ى/g,"ي")
        .replace(/ؤ/g,"و")
        .replace(/ئ/g,"ي")
        .replace(/ء/g,"")
        .replace(/گ/g,"ك").replace(/پ/g,"ب").replace(/ژ/g,"ز").replace(/ڤ/g,"ف");

      // حذف "ال/أل/الـ" بداية الكلمات
      text = text.replace(/(^|\s)أ?ل/g, "$1");

      // توحيد المسافات وازالة غير الحرف/الرقم
      text = text.replace(/[^\p{L}\p{N}\s]+/gu," ").replace(/\s+/g," ").trim();

      // تحويل الأرقام المكتوبة/المنطوقة إلى أرقام
      const numMap = {
        // 1..10 بالعربي الفصيح/العامية/الإنجليزي المنطوق
        "واحد":"1","١":"1","one":"1","ون":"1",
        "اتنين":"2","اثنين":"2","٢":"2","two":"2","تو":"2","تين":"2",
        "تلاته":"3","ثلاثه":"3","ثلاثة":"3","٣":"3","three":"3","ثري":"3","تلات":"3",
        "اربعه":"4","أربعة":"4","٤":"4","four":"4","فور":"4",
        "خمسه":"5","خمسة":"5","٥":"5","five":"5","فايف":"5",
        "سته":"6","ستة":"6","٦":"6","six":"6","سكس":"6",
        "سبعه":"7","سبعة":"7","٧":"7","seven":"7","سفن":"7",
        "تمانيه":"8","ثمانيه":"8","ثمانية":"8","٨":"8","eight":"8","ايت":"8",
        "تسعه":"9","تسعة":"9","٩":"9","nine":"9","ناين":"9",
        "عشره":"10","عشرة":"10","١٠":"10","ten":"10","تن":"10"
      };
      // أسماء/نطق الحروف الشائع
      const letterMap = {
        "الف":"ا","ألف":"ا","الفا":"ا",
        "باء":"ب","بي":"ب","بيه":"ب",
        "تاء":"ت","تي":"ت","تيه":"ت",
        "جيم":"ج","جي":"ج",
        "دال":"د","دي":"د",
        "هاء":"ه","هيه":"ه",
        "واو":"و",
        "ياء":"ي","ياي":"ي","يي":"ي",
        "اي":"a","إي":"a","ايه":"a",
        "سي":"c","سيه":"c","دي":"d","ديه":"d",
        "كي":"k","كيه":"k",
        "اكس":"x","إكس":"x",
        "زد":"z","زي":"z"
      };

      // استبدال كلمات الأعداد أولاً
      Object.keys(numMap).forEach(k=>{
        text = text.replace(new RegExp(`\\b${k}\\b`,"g"), numMap[k]);
      });

      // استبدال أسماء الحروف
      Object.keys(letterMap).forEach(k=>{
        text = text.replace(new RegExp(`\\b${k}\\b`,"g"), letterMap[k]);
      });

      // في النهاية: إزالة المسافات تماماً حتى نتخطى اختلافات بسيطة
      return text.replace(/\s+/g,"");
    }

    // فهرس أسماء المحطات بالتطبيع لمطابقة قوية
    const stationIndex = stations.map(st => ({
      norm: normalizeName(st.name),
      ref: st
    }));

    // تطابق اسم واحد
    function findStationByText(userText){
      const norm = normalizeName(userText);
      // تطابق تام للنص المُطبّع
      let hit = stationIndex.find(x => x.norm === norm);
      if (hit) return [hit.ref];

      // تطابق يحتوي/جزئي
      const partial = stationIndex
        .filter(x => x.norm.includes(norm) || norm.includes(x.norm))
        .map(x => x.ref);

      // إزالة التكرار بالأسماء
      const unique = [];
      const seen = new Set();
      for(const s of partial){
        if(!seen.has(s.name)){ seen.add(s.name); unique.push(s); }
      }
      return unique;
    }

    // ======== أوامر صوتية/نصية ========
    const voiceNearestPatterns = [
      /اقرب محطة/i, /فين اقرب محطة/i, /اقرب محطه فين/i, /اين اقرب محطة/i, /هاتلي اقرب محطة/i, /وديني/i
    ];

    function handleUserMessage(raw){
      const text = raw.trim();
      if(!text) return;

      appendAssistantMessage("أنت", text);

      // أقرب محطة
      if (voiceNearestPatterns.some(p=>p.test(text))) {
        appendAssistantMessage("المساعد","ثواني... بجمع أقرب المحطات من موقعك 🔍");
        showNearestStations();
        return;
      }

      // أوامر تكبير/تصغير
      if (text.includes("تكبير")) { map.setZoom(map.getZoom()+1); appendAssistantMessage("المساعد","تم تكبير الخريطة."); return; }
      if (text.includes("تصغير")) { map.setZoom(map.getZoom()-1); appendAssistantMessage("المساعد","تم تصغير الخريطة."); return; }
      if (text.includes("إظهار كل المحطات")) { map.setZoom(10); map.setCenter({lat:30.05,lng:31.3}); appendAssistantMessage("المساعد","تم إظهار كل المحطات."); return; }

      // بحث بالاسم (مع التطبيع الذكي)
      const matches = findStationByText(text);

      if (matches.length === 1){
        const st = matches[0];
        showStationInfo(st);
        const link = `https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}`;
        appendAssistantMessage("المساعد", `تم تحديد <a target="_blank" class="clickable-station" href="${link}">${st.name}</a> على الخريطة.`);
      } else if (matches.length > 1){
        const msg = matches.map(m=>{
          const link = `https://www.google.com/maps/search/?api=1&query=${m.lat},${m.lon}`;
          return `${m.name}: <a target="_blank" href="${link}">افتح</a>`;
        }).join("<br>");
        appendAssistantMessage("المساعد", `وجدت أكثر من محطة متقاربة:<br>${msg}<br>اكتب الاسم بدقة أكبر لتحديد محطة واحدة.`);
      } else {
        appendAssistantMessage("المساعد", "لم أتعرف على المحطة، جرّب كتابة/نطق الاسم بشكل أقرب أو استخدم زر أقرب المحطات.");
      }
    }

    // ======== زر الإرسال ========
    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById("sendBtn").addEventListener("click", ()=>{
        const inp = document.getElementById("userInput");
        handleUserMessage(inp.value);
        inp.value = "";
      });
      document.getElementById("userInput").addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ document.getElementById("sendBtn").click(); }
      });
    });

    // ======== البحث الصوتي (Web Speech API) ========
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    if (SpeechRecognition){
      recognition = new SpeechRecognition();
      recognition.lang = "ar-EG"; // عربي مصر
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.addEventListener("result", (e)=>{
        const transcript = Array.from(e.results).map(r=>r[0].transcript).join(" ").trim();
        document.getElementById("userInput").value = transcript;
        handleUserMessage(transcript);
      });
      recognition.addEventListener("end", ()=>{
        micBtn.classList.remove("listening");
      });
    }

    const micBtn = document.getElementById("micBtn");
    micBtn.addEventListener("click", ()=>{
      if(!recognition){
        appendAssistantMessage("المساعد","متصفحك لا يدعم البحث الصوتي. جرّب Chrome/Android.");
        return;
      }
      // ابدأ/أعد البدء
      try{
        micBtn.classList.add("listening");
        recognition.start();
        appendAssistantMessage("المساعد","اسمعك الآن... تفضل بالنطق 🎤");
      }catch(_){
        // في بعض المتصفحات start يرمي خطأ لو قيد التشغيل
        try{ recognition.stop(); }catch(__){}
        setTimeout(()=>{ recognition.start(); },150);
        micBtn.classList.add("listening");
      }
    });

    // زر عام في الصفحة لعرض الأقرب (اختياري)
    window.showNearestStations = showNearestStations;
  </script>

  <!-- خرائط جوجل: استبدل بمفتاحك -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY&callback=initMap" async defer></script>

  <div style="text-align:center;margin:15px;">
    <button onclick="showNearestStations()" style="padding:10px 20px;font-size:16px;background-color:#007BFF;color:#fff;border:none;border-radius:6px;cursor:pointer;">
      عرض أقرب المحطات
    </button>
  </div>

</body>
</html>
