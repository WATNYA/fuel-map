<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø®Ø±ÙŠØ·Ø© Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ù…Ø¹ Ø£ÙˆØ§Ù…Ø± Ø°ÙƒÙŠØ© + Clustering</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #007BFF;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    #container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #sidebar {
      width: 250px;
      background: #fff;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 0.5rem;
    }
    #sidebar h2 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #sidebar li {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #sidebar li:hover {
      background: #f0f0f0;
    }
    #map {
      flex: 1 1 auto;
    }
    #infoBar {
      background: #007BFF;
      color: #fff;
      padding: 0.5rem;
      text-align: center;
      flex-shrink: 0;
    }
    #assistant {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 300px;
      max-width: 90%;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #assistant h3 {
      background: #007BFF;
      color: #fff;
      padding: 0.5rem;
      margin: 0;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    #assistant #messages {
      height: 150px;
      overflow-y: auto;
      padding: 0.5rem;
      border-bottom: 1px solid #ddd;
      font-size: 0.9rem;
    }
    #assistant #input {
      display: flex;
      padding: 0.5rem;
      gap: 0.5rem;
      align-items: center;
    }
    #assistant input {
      flex: 1;
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #assistant button {
      padding: 0.3rem 0.5rem;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Ø²Ø± Ø§Ù„Ù…ÙŠÙƒ Ù„Ù…Ø§ Ø¨ÙŠØ³ØªÙ…Ø¹ */
    #assistant #micBtn.listening { background:#dc3545; color:#fff; }

    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #sidebar {
        width: 100%;
        max-height: 200px;
        border-left: none;
        border-top: 1px solid #ddd;
      }
      #assistant {
        left: 50%;
        transform: translateX(-50%);
        bottom: 10px;
        width: 95%;
        max-width: 350px;
      }
    }
    #toggleSidebar, #toggleAssistant {
      position: absolute;
      top: 5px;
      left: 5px;
      z-index: 10;
      padding: 2px 5px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .collapsedSidebar { display: none !important; }
    .collapsedAssistant { display: none !important; }

    .clickable-station {
      color: darkgreen;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>

<button id="sidebarToggleBtn" onclick="toggleSidebar()" style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">ğŸ“Œ</button>
<button id="assistantToggleBtn" onclick="toggleAssistant()" style="position: fixed; bottom: 10px; right: 10px; z-index: 9999; display: none;">ğŸ’¬</button>

<header>Ø®Ø±ÙŠØ·Ø© Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯</header>

<div id="container">
  <div id="sidebar">
    <button id="toggleSidebar" onclick="toggleSidebar()">â›¶</button>
    <h2>Ø§Ù„Ù…Ø­Ø·Ø§Øª</h2>
    <ul id="stationList"></ul>
  </div>
  <div id="map"></div>
</div>

<div id="infoBar">Ø§Ø®ØªØ± Ù…Ø­Ø·Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ø³Ù…Ù‡Ø§ Ù‡Ù†Ø§</div>

<div id="assistant">
  <button id="toggleAssistant" onclick="toggleAssistant()">â›¶</button>
  <h3>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª</h3>
  <div id="messages"></div>
  <div id="input">
    <!-- Ø²Ø± Ø§Ù„Ù…ÙŠÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <button id="micBtn" title="Ø§Ø¨Ø¯Ø£/Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ­Ø¯Ø«">ğŸ™ï¸</button>
    <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ... Ø£Ùˆ Ø§Ø¶ØºØ· ğŸ™ï¸ ÙˆØªÙƒÙ„Ù…">
    <button onclick="sendAssistantMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø¯ÙŠÙƒ ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ ÙˆØ³ÙˆÙ… <script src="..."> â€” Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø¨ØªØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ùˆ ÙÙŠÙ‡ src.
     Ø³Ø¨ØªÙ‡ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ Ø¹Ø´Ø§Ù† Ù…Ø§ Ø£ØºÙŠØ±Ø´ Ø¨Ù†ÙŠØ© ÙƒÙˆØ¯ÙƒØŒ ÙˆÙÙŠÙ‡ ØªÙƒØ±Ø§Ø±Ø§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨ØªØºØ·ÙŠ Ù†ÙØ³ Ø§Ù„Ø¯ÙˆØ§Ù„. -->
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
function getDistance(lat1, lon1, lat2, lon2) { /* Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡ Ø¨Ø³Ø¨Ø¨ ÙˆØ¬ÙˆØ¯ src */ }
</script>

<script>
let nearestRequestCount = 0;

const stations = [
  { name: 'Ø±Ø¦Ø§Ø³Ø© Ø§Ù„Ø´Ø±ÙƒØ©', lat: 30.075775, lon: 31.31986388888889 },
  { name: 'Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ·Ù†ÙŠØ©', lat: 30.10302222222222, lon: 31.81430833333333 },
  { name: 'Ø¬Ø±Ø§Ø¬ ÙØ±Ø¹ Ø§Ù„Ù†Ù‚Ù„', lat: 30.101125, lon: 31.81966111111111 },
  { name: 'Ù…Ø±ÙƒØ² Ø§Ù„ØµÙŠØ§Ù†Ø©', lat: 30.07979166666666, lon: 31.38048611111111 },
  { name: 'Ø§Ù„Ù…Ù‚Ø·Ù…', lat: 29.98694824132808, lon: 31.30985320769065 },
  /* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ ... */
  { name: 'Ø´Ù„Ø§ØªÙŠÙ†', lat: 23.11694444444445, lon: 35.53583333333333 }
];

let map;
let infoWindow;
let markers = [];

let lastWelcomeTime = 0;
let welcomeCount = 0;
let pendingStation = null;
let autoAskCooldown = false;
let lastUserTime = Date.now();

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 30.05, lng: 31.3 },
    zoom: 10
  });
  infoWindow = new google.maps.InfoWindow();
  stations.forEach(station => {
    const marker = new google.maps.Marker({
      position: { lat: station.lat, lng: station.lon },
      map: map,
      title: station.name
    });
    marker.addListener("click", () => showStationInfo(station));
    markers.push(marker);
    addToSidebar(station, marker);
  });
  new MarkerClusterer(map, markers, {
    imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
  });
}

function showStationInfo(station) {
  map.setCenter({ lat: station.lat, lng: station.lon });
  map.setZoom(15);
  infoWindow.setContent(`<strong>${station.name}</strong>`);
  infoWindow.setPosition({ lat: station.lat, lng: station.lon });
  infoWindow.open(map);
  const mapsLink = `https://www.google.com/maps/search/?api=1&query=${station.lat},${station.lon}`;
  document.getElementById("infoBar").innerHTML = `Ø§Ù„Ù…Ø­Ø·Ø©: ${station.name} | <a href="${mapsLink}" target="_blank">Ø§ÙØªØ­ ÙÙŠ Google Maps</a>`;
}

function addToSidebar(station, marker) {
  const li = document.createElement("li");
  li.innerText = station.name;
  li.addEventListener("click", () => {
    map.setCenter(marker.getPosition());
    map.setZoom(15);
    showStationInfo(station);
  });
  document.getElementById("stationList").appendChild(li);
}

function appendAssistantMessage(sender, text) {
  const msg = document.createElement("div");
  msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
  const panel = document.getElementById("messages");
  panel.appendChild(msg);
  panel.scrollTop = panel.scrollHeight;
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function findNearestStations(userLat, userLon, limit = 5) {
  return stations.map(st => ({ ...st, distance: getDistance(userLat, userLon, st.lat, st.lon) }))
                 .sort((a, b) => a.distance - b.distance)
                 .slice(0, limit);
}

function showNearestStations() {
  if (!navigator.geolocation) {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
    return;
  }

  nearestRequestCount++;
  if (nearestRequestCount > 4) {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ø¬Ø±Ø¨ Ø£Ù…Ø±Ù‹Ø§ Ø¢Ø®Ø± Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ù…Ø²ÙŠØ¯Ù‹Ø§ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©.");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const userLat = pos.coords.latitude;
    const userLon = pos.coords.longitude;
    const nearest = findNearestStations(userLat, userLon, 5);

    map.setCenter({ lat: userLat, lng: userLon });
    map.setZoom(13);

    nearest.forEach(st => {
      new google.maps.Marker({
        position: { lat: st.lat, lng: st.lon },
        map: map,
        title: st.name,
        icon: { url: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png" }
      });
    });

    new google.maps.Marker({
      position: { lat: userLat, lng: userLon },
      map: map,
      title: "Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ",
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: "#00f",
        fillOpacity: 0.8,
        strokeColor: "#fff",
        strokeWeight: 2
      }
    });

    let msg = "Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¥Ù„ÙŠÙƒ:<br>";
    nearest.forEach(st => {
      msg += `<a href='https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}' target='_blank' class='clickable-station'>${st.name}</a> (Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ ${st.distance.toFixed(2)} ÙƒÙ…)<br>`;
    });
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", msg);
  }, err => {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS.");
  });
}

const voicePatterns = [
  /Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i,
  /ÙˆØ¯ÙŠÙ†ÙŠ/i,
  /ÙÙŠÙ† Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i,
  /Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ù‡ ÙÙŠÙ†/i,
  /Ø§ÙŠÙ† Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i,
  /Ù‡Ø§ØªÙ„ÙŠ Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i
];

function handleUserMessage(text) {
  const matched = voicePatterns.some(pat => pat.test(text));
  if (matched) {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø«ÙˆØ§Ù†ÙŠ... Ø¨Ø¬Ù…Ø¹ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ ğŸ”");
    showNearestStations();
    return;
  }
  const found = stations.find(st => st.name.includes(text));
  if (found) {
    map.setCenter({ lat: found.lat, lng: found.lon });
    map.setZoom(15);
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯",
      `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰: <a href='https://www.google.com/maps/search/?api=1&query=${found.lat},${found.lon}' target='_blank' class='clickable-station'>${found.name}</a>`);
  } else {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ù„Ù… Ø£ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø©ØŒ Ø­Ø§ÙˆÙ„ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø¨Ø´ÙƒÙ„ Ø£Ø¯Ù‚.");
  }
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('sidebarToggleBtn');
  sidebar.classList.toggle('collapsedSidebar');
  btn.style.display = sidebar.classList.contains('collapsedSidebar') ? 'block' : 'none';
  google.maps.event.trigger(map, 'resize');
}

function toggleAssistant() {
  const assistant = document.getElementById('assistant');
  const btn = document.getElementById('assistantToggleBtn');
  assistant.classList.toggle('collapsedAssistant');
  btn.style.display = assistant.classList.contains('collapsedAssistant') ? 'block' : 'none';
}

function sendAssistantMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;

  appendAssistantMessage("Ø£Ù†Øª", text);
  input.value = "";
  lastUserTime = Date.now();

  if (text.includes("ØªÙƒØ¨ÙŠØ±")) {
    map.setZoom(map.getZoom() + 1);
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªÙ… ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
    return;
  } else if (text.includes("ØªØµØºÙŠØ±")) {
    map.setZoom(map.getZoom() - 1);
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
    return;
  } else if (text.includes("Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ø§Ù„Ù…Ø­Ø·Ø§Øª")) {
    map.setZoom(10);
    map.setCenter({ lat: 30.05, lng: 31.3 });
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ø§Ù„Ù…Ø­Ø·Ø§Øª.");
    return;
  }

  // Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Øµ
  handleUserMessage(text);
}
</script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvoe3QqZfJbxNinSwPcgONdLDhyQF7OlQ&callback=initMap" async defer></script>

<div style="text-align: center; margin: 15px;">
  <button onclick="showNearestStations()" style="padding: 10px 20px; font-size: 16px; background-color: #007BFF; color: white; border: none; border-radius: 6px; cursor: pointer;">
    Ø¹Ø±Ø¶ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª
  </button>
</div>

<!-- ======== Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ ======== -->
<script>
(function () {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognizer = null;
  let listening = false;
  const micBtnEl = document.getElementById("micBtn");

  function ensureRecognizer() {
    if (!SR) {
      appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
      return null;
    }
    if (recognizer) return recognizer;

    recognizer = new SR();
    recognizer.lang = "ar-EG";
    recognizer.interimResults = false;
    recognizer.continuous = false; // Ø¬Ù…Ù„Ø© Ù„ÙƒÙ„ Ø¶ØºØ·Ø©

    recognizer.onstart = () => {
      listening = true;
      micBtnEl && micBtnEl.classList.add("listening");
      appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø§ØªÙØ¶Ù„ Ø§ØªÙƒÙ„Ù…â€¦");
    };

    recognizer.onresult = (e) => {
      const transcript = (e.results && e.results[0] && e.results[0][0] && e.results[0][0].transcript || "").trim();
      const input = document.getElementById("userInput");
      if (input) input.value = transcript;
      appendAssistantMessage("Ø£Ù†Øª", transcript);
      if (typeof sendAssistantMessage === "function") sendAssistantMessage();
    };

    recognizer.onerror = (e) => {
      const msg = (e && e.error) ? e.error : "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹: " + msg);
    };

    recognizer.onend = () => {
      listening = false;
      micBtnEl && micBtnEl.classList.remove("listening");
    };

    return recognizer;
  }

  function toggleListening() {
    const r = ensureRecognizer();
    if (!r) return;
    try {
      if (listening) r.stop(); else r.start();
    } catch(_) {}
  }

  if (micBtnEl) {
    micBtnEl.addEventListener("click", function () {
      try { window.speechSynthesis && speechSynthesis.cancel(); } catch(_) {}
      toggleListening();
    });
  }
})();
</script>

<!-- Ø³ÙƒØ±Ø¨Øª ØµØºÙŠØ± Ù„Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ± -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("userInput");
  if (input) {
    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        sendAssistantMessage();
      }
    });
  }
});
</script>

</body>
</html>
