<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø®Ø±ÙŠØ·Ø© Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ù…Ø¹ Ø£ÙˆØ§Ù…Ø± Ø°ÙƒÙŠØ© + Clustering + Ø¨Ø­Ø« ØµÙˆØªÙŠ</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #007BFF;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    #container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #sidebar {
      width: 260px;
      background: #fff;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 0.5rem;
    }
    #sidebar h2 { font-size: 1.2rem; margin-bottom: 0.5rem; }
    #sidebar ul { list-style: none; padding: 0; margin: 0; }
    #sidebar li {
      padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee;
    }
    #sidebar li:hover { background: #f0f0f0; }
    #map { flex: 1 1 auto; }
    #infoBar {
      background: #007BFF; color: #fff; padding: 0.5rem;
      text-align: center; flex-shrink: 0;
    }
    #assistant {
      position: fixed; bottom: 10px; left: 10px; width: 320px; max-width: 90%;
      background: #fff; border: 1px solid #ccc; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #assistant h3 {
      background: #007BFF; color: #fff; padding: 0.5rem; margin: 0;
      border-top-left-radius: 8px; border-top-right-radius: 8px;
    }
    #assistant #messages {
      height: 160px; overflow-y: auto; padding: 0.5rem;
      border-bottom: 1px solid #ddd; font-size: 0.9rem;
    }
    #assistant #input {
      display: flex; padding: 0.5rem; gap: 0.5rem; align-items: center;
    }
    #assistant input {
      flex: 1; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px;
    }
    #assistant button {
      padding: 0.4rem 0.6rem; background: #007BFF; color: #fff; border: none;
      border-radius: 4px; cursor: pointer;
    }
    .mic-btn {
      width: 40px; height: 40px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      background: #e9f2ff; color: #007BFF; border: 1px solid #bcd8ff;
      cursor: pointer; font-size: 18px;
    }
    .mic-btn.listening {
      background: #ffe9ec; color: #d1002f; border-color: #ffc0cb;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(209,0,47,0.4); }
      70% { box-shadow: 0 0 0 12px rgba(209,0,47,0); }
      100% { box-shadow: 0 0 0 0 rgba(209,0,47,0); }
    }
    .clickable-station { color: darkgreen; cursor: pointer; text-decoration: underline; }
    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #sidebar {
        width: 100%; max-height: 220px; border-left: none; border-top: 1px solid #ddd;
      }
      #assistant {
        left: 50%; transform: translateX(-50%); bottom: 10px; width: 95%; max-width: 360px;
      }
    }
  </style>
</head>
<body>

  <header>Ø®Ø±ÙŠØ·Ø© Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯</header>

  <div id="container">
    <div id="sidebar">
      <h2>Ø§Ù„Ù…Ø­Ø·Ø§Øª</h2>
      <ul id="stationList"></ul>
    </div>
    <div id="map"></div>
  </div>

  <div id="infoBar">Ø§Ø®ØªØ± Ù…Ø­Ø·Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ø³Ù…Ù‡Ø§ Ù‡Ù†Ø§</div>

  <div id="assistant">
    <h3>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª</h3>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø© Ø£Ùˆ Ø£Ù…Ø± Ù…Ø«Ù„: Ø£Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©">
      <button id="micBtn" class="mic-btn" title="Ø¨Ø­Ø« ØµÙˆØªÙŠ">ğŸ¤</button>
      <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- MarkerClusterer -->
  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

  <script>
    // ================== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==================
    const stations = [
      // TODO: Ø§Ù„ØµÙ‚ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø·Ø§ØªÙƒ Ù‡Ù†Ø§ (Ù†ÙØ³ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§)
      // Ø£Ù…Ø«Ù„Ø© Ù‚ØµÙŠØ±Ø© ÙÙ‚Ø·:
      { name: 'Ø±Ø¦Ø§Ø³Ø© Ø§Ù„Ø´Ø±ÙƒØ©', lat: 30.075775, lon: 31.31986388888889 },
      { name: 'Ø®Ù„Ù Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ø´Ø±Ø·Ø©', lat: 30.0494630429643, lon: 31.44170636619374 },
      { name: 'Ø§Ù„Ø±Ø­Ø§Ø¨', lat: 30.04365008035782, lon: 31.49653604012123 }
    ];

    // ================== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ==================
    let map, infoWindow;
    let markers = [];
    let nearestRequestCount = 0;

    // ================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ==================
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 30.05, lng: 31.3 },
        zoom: 10
      });
      infoWindow = new google.maps.InfoWindow();

      stations.forEach(st => {
        const marker = new google.maps.Marker({
          position: { lat: st.lat, lng: st.lon },
          map,
          title: st.name
        });
        marker.addListener("click", () => showStationInfo(st));
        markers.push(marker);

        const li = document.createElement("li");
        li.textContent = st.name;
        li.onclick = () => { showStationInfo(st); };
        document.getElementById("stationList").appendChild(li);
      });

      new MarkerClusterer(map, markers, {
        imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
      });
    }

    function showStationInfo(station) {
      map.setCenter({ lat: station.lat, lng: station.lon });
      map.setZoom(15);
      infoWindow.setContent(`<strong>${station.name}</strong>`);
      infoWindow.setPosition({ lat: station.lat, lng: station.lon });
      infoWindow.open(map);
      const mapsLink = `https://www.google.com/maps/search/?api=1&query=${station.lat},${station.lon}`;
      document.getElementById("infoBar").innerHTML =
        `Ø§Ù„Ù…Ø­Ø·Ø©: ${station.name} | <a href="${mapsLink}" target="_blank">Ø§ÙØªØ­ ÙÙŠ Google Maps</a>`;
    }

    function appendAssistantMessage(sender, html) {
      const msg = document.createElement("div");
      msg.innerHTML = `<strong>${sender}:</strong> ${html}`;
      const box = document.getElementById("messages");
      box.appendChild(msg);
      box.scrollTop = box.scrollHeight;
    }

    // ================== Ù…Ø³Ø§ÙØ§Øª ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© ==================
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function findNearestStations(userLat, userLon, limit = 5) {
      return stations.map(st => ({ ...st, distance: getDistance(userLat, userLon, st.lat, st.lon) }))
                     .sort((a, b) => a.distance - b.distance)
                     .slice(0, limit);
    }

    function showNearestStations() {
      if (!navigator.geolocation) {
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.");
        return;
      }

      nearestRequestCount++;
      if (nearestRequestCount > 4) {
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ø¬Ø±Ù‘Ø¨ Ø£Ù…Ø±Ù‹Ø§ Ø¢Ø®Ø± Ù„Ùˆ Ø³Ù…Ø­Øª.");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;
        const nearest = findNearestStations(userLat, userLon, 5);

        map.setCenter({ lat: userLat, lng: userLon });
        map.setZoom(13);

        new google.maps.Marker({
          position: { lat: userLat, lng: userLon },
          map,
          title: "Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8, fillColor: "#00f", fillOpacity: 0.8,
            strokeColor: "#fff", strokeWeight: 2
          }
        });

        let msg = "Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¥Ù„ÙŠÙƒ:<br>";
        nearest.forEach(st => {
          new google.maps.Marker({
            position: { lat: st.lat, lng: st.lon },
            map, title: st.name,
            icon: { url: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png" }
          });
          const link = `https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}`;
          msg += `<a href="${link}" target="_blank" class="clickable-station">${st.name}</a> (Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ ${st.distance.toFixed(2)} ÙƒÙ…)<br>`;
        });
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", msg);
      }, _ => {
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙˆØ¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
      });
    }

    // ================== ØªØ·Ø¨ÙŠØ¹ Ø¹Ø±Ø¨ÙŠ Ø°ÙƒÙŠ ==================
    function normalizeName(text) {
      if (!text) return "";
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ©
      const arabicDigits = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©";
      const latinDigits  = "0123456789";

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ ÙˆØ§Ù„ØªØ·ÙˆÙŠÙ„
      text = text
        .replace(/[\u0617-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, "")
        .replace(/\u0640/g, ""); // Ù€

      // ØªÙˆØ­ÙŠØ¯ Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ù‡Ù…Ø²Ø§Øª
      text = text
        .replace(/[Ø¢Ø£Ø¥Ù±]/g, "Ø§")
        .replace(/Ø©/g, "Ù‡")
        .replace(/Ù‰/g, "ÙŠ")
        .replace(/Ø¤/g, "Ùˆ")
        .replace(/Ø¦/g, "ÙŠ")
        .replace(/Ø¡/g, "")
        .replace(/Ú¯/g, "Ùƒ")
        .replace(/Ù¾/g, "Ø¨")
        .replace(/Ú˜/g, "Ø²")
        .replace(/Ú¤/g, "Ù");

      // Ø¥Ø²Ø§Ù„Ø© "Ø§Ù„" Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø£ÙŠÙ†Ù…Ø§ Ø¸Ù‡Ø±Øª Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
      text = text.replace(/(^|\s)Ø§Ù„/g, "$1");

      // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ù…Ø§Øª Ø¹Ø§Ù…Ø©
      text = text
        .replace(/\b(Ù…Ø­Ø·Ù‡|Ù…Ø­Ø·Ø©|Ù…Ø­Ø·Ø§Øª)\b/gi, "")
        .replace(/\b(Ø´Ø±ÙƒØ©|Ø§Ù„Ø´Ø±ÙƒÙ‡|Ø£Ù„Ø´Ø±ÙƒØ©|Ø§Ù„Ø´Ø±ÙƒØ©)\b/gi, "")
        .replace(/\b(ÙˆØ·Ù†ÙŠØ©|Ø§Ù„ÙˆØ·Ù†ÙŠÙ‡|Ø§Ù„ÙˆØ·Ù†ÙŠØ©)\b/gi, "");

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
      text = text.replace(/[Ù -Ù©]/g, d => latinDigits[arabicDigits.indexOf(d)]);

      // Ø­Ø°Ù ØºÙŠØ± Ø§Ù„Ø­Ø±ÙˆÙ/Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
      text = text.replace(/[^\p{L}\p{N}]+/gu, "");

      return text.toLowerCase();
    }

    function smartMatchAll(userText) {
      const userNorm = normalizeName(userText);
      if (!userNorm) return [];

      // Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
      let results = stations.filter(s => normalizeName(s.name).includes(userNorm));
      if (results.length) return results;

      // fallback Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ© Ø§Ù„ØµØºÙŠØ±Ø©
      function editDistance(a, b) {
        const dp = Array.from({length: a.length + 1}, () => Array(b.length + 1).fill(0));
        for (let i=0;i<=a.length;i++) dp[i][0]=i;
        for (let j=0;j<=b.length;j++) dp[0][j]=j;
        for (let i=1;i<=a.length;i++){
          for (let j=1;j<=b.length;j++){
            const cost = a[i-1] === b[j-1] ? 0 : 1;
            dp[i][j] = Math.min(
              dp[i-1][j] + 1,
              dp[i][j-1] + 1,
              dp[i-1][j-1] + cost
            );
          }
        }
        return dp[a.length][b.length];
      }
      const MAX_DIST = 2;
      results = stations.filter(s => editDistance(normalizeName(s.name), userNorm) <= MAX_DIST);
      return results;
    }

    // ================== Ø£ÙˆØ§Ù…Ø± ØµÙˆØªÙŠØ© Ø¬Ø§Ù‡Ø²Ø© ==================
    const voicePatterns = [
      /Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i, /ÙˆØ¯ÙŠÙ†ÙŠ/i, /ÙÙŠÙ† Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i, /Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ù‡ ÙÙŠÙ†/i, /Ø§ÙŠÙ† Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i, /Ù‡Ø§ØªÙ„ÙŠ Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i
    ];

    function handleUserMessage(text) {
      // Ø£ÙˆØ§Ù…Ø± Ø¹Ø§Ù…Ø©
      if (voicePatterns.some(p => p.test(text))) {
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø­Ø§Ø¶Ø±.. Ø¨Ø¬Ù…Ø¹ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ ğŸ”");
        showNearestStations();
        return;
      }

      if (text.includes("ØªÙƒØ¨ÙŠØ±")) { map.setZoom(map.getZoom() + 1); appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯","ØªÙ… ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©."); return; }
      if (text.includes("ØªØµØºÙŠØ±")) { map.setZoom(map.getZoom() - 1); appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯","ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©."); return; }
      if (text.includes("Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ø§Ù„Ù…Ø­Ø·Ø§Øª")) { map.setZoom(10); map.setCenter({lat:30.05,lng:31.3}); appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯","ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ø§Ù„Ù…Ø­Ø·Ø§Øª."); return; }

      // Ø¨Ø­Ø« Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø°ÙƒÙŠ
      const matches = smartMatchAll(text);
      if (matches.length === 1) {
        showStationInfo(matches[0]);
        const link = `https://www.google.com/maps/search/?api=1&query=${matches[0].lat},${matches[0].lon}`;
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", `ØªÙ… ØªØ­Ø¯ÙŠØ¯ ${matches[0].name} Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. <a href="${link}" target="_blank">Ø§Ø¯Ø®Ù„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø·Ø©</a>`);
      } else if (matches.length > 1) {
        const namesWithLinks = matches.map(m => {
          const link = `https://www.google.com/maps/search/?api=1&query=${m.lat},${m.lon}`;
          return `${m.name}: <a href="${link}" target="_blank">Ø§Ø¯Ø®Ù„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø·Ø©</a>`;
        }).join("<br>");
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", `ÙˆØ¬Ø¯Øª Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:<br>${namesWithLinks}<br>Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.`);
      } else {
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ù„Ù… Ø£ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø©ØŒ Ø­Ø§ÙˆÙ„ ÙƒØªØ§Ø¨Ø©/Ù†Ø·Ù‚ Ø§Ù„Ø§Ø³Ù… Ø¨Ø´ÙƒÙ„ Ø£Ù‚Ø±Ø¨.");
      }
    }

    // ================== Ø¥Ø±Ø³Ø§Ù„ Ù†ØµÙŠ ==================
    document.getElementById("sendBtn").addEventListener("click", () => {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;
      appendAssistantMessage("Ø£Ù†Øª", text);
      input.value = "";
      handleUserMessage(text);
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
    document.getElementById("userInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") document.getElementById("sendBtn").click();
    });

    // ================== Ø¨Ø­Ø« ØµÙˆØªÙŠ ==================
    (function setupVoiceSearch(){
      const micBtn = document.getElementById("micBtn");
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        micBtn.disabled = true;
        micBtn.title = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ";
        return;
      }

      const recog = new SpeechRecognition();
      recog.lang = "ar-EG";
      recog.interimResults = false;
      recog.maxAlternatives = 1;

      let listening = false;

      function start() {
        if (listening) return;
        listening = true;
        micBtn.classList.add("listening");
        micBtn.title = "Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... Ø§Ø¶ØºØ· Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù";
        try { recog.start(); } catch (_) {}
      }

      function stop() {
        listening = false;
        micBtn.classList.remove("listening");
        micBtn.title = "Ø¨Ø­Ø« ØµÙˆØªÙŠ";
        try { recog.stop(); } catch (_) {}
      }

      micBtn.addEventListener("click", () => {
        if (!listening) start(); else stop();
      });

      recog.onresult = (e) => {
        stop();
        const transcript = (e.results[0] && e.results[0][0] && e.results[0][0].transcript) ? e.results[0][0].transcript : "";
        if (transcript) {
          appendAssistantMessage("Ø£Ù†Øª (ØµÙˆØª)", transcript);
          // Ù…Ø±Ø±Ù‡ Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©
          handleUserMessage(transcript);
        } else {
          appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ù„Ù… Ø£Ø³Ù…Ø¹ Ø´ÙŠØ¦Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
      };

      recog.onerror = (e) => {
        stop();
        appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ.");
      };

      recog.onend = () => { stop(); };
    })();

    // Ø§Ø¬Ø¹Ù„ initMap Ù…ØªØ§Ø­Ø© Ù„Ø³ÙƒØ±Ø¨Øª Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
    window.initMap = initMap;
  </script>

  <!-- Google Maps (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù…ÙØªØ§Ø­Ùƒ Ø¥Ù† Ù„Ø²Ù…) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap" async defer></script>

  <div style="text-align: center; margin: 15px;">
    <button onclick="showNearestStations()" style="padding: 10px 20px; font-size: 16px; background-color: #007BFF; color: white; border: none; border-radius: 6px; cursor: pointer;">
      Ø¹Ø±Ø¶ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª
    </button>
  </div>
</body>
</html>
