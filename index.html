<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø®Ø±ÙŠØ·Ø© Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ù…Ø¹ Ø£ÙˆØ§Ù…Ø± Ø°ÙƒÙŠØ© + Clustering</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #007BFF;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    #container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #sidebar {
      width: 250px;
      background: #fff;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 0.5rem;
    }
    #sidebar h2 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #sidebar li {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #sidebar li:hover {
      background: #f0f0f0;
    }
    #map {
      flex: 1 1 auto;
    }
    #infoBar {
      background: #007BFF;
      color: #fff;
      padding: 0.5rem;
      text-align: center;
      flex-shrink: 0;
    }
    #assistant {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 300px;
      max-width: 90%;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #assistant h3 {
      background: #007BFF;
      color: #fff;
      padding: 0.5rem;
      margin: 0;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    #assistant #messages {
      height: 150px;
      overflow-y: auto;
      padding: 0.5rem;
      border-bottom: 1px solid #ddd;
      font-size: 0.9rem;
    }
    #assistant #input {
      display: flex;
      padding: 0.5rem;
      gap: 0.5rem;
      align-items: center;
    }
    #assistant input {
      flex: 1;
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #assistant button {
      padding: 0.3rem 0.5rem;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #assistant #micBtn.listening { background:#dc3545; color:#fff; }

    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #sidebar {
        width: 100%;
        max-height: 200px;
        border-left: none;
        border-top: 1px solid #ddd;
      }
      #assistant {
        left: 50%;
        transform: translateX(-50%);
        bottom: 10px;
        width: 95%;
        max-width: 350px;
      }
    }
    #toggleSidebar, #toggleAssistant {
      position: absolute;
      top: 5px;
      left: 5px;
      z-index: 10;
      padding: 2px 5px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .collapsedSidebar { display: none !important; }
    .collapsedAssistant { display: none !important; }

    .clickable-station {
      color: darkgreen;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>

<button id="sidebarToggleBtn" onclick="toggleSidebar()" style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">ğŸ“Œ</button>
<button id="assistantToggleBtn" onclick="toggleAssistant()" style="position: fixed; bottom: 10px; right: 10px; z-index: 9999; display: none;">ğŸ’¬</button>

<header>Ø®Ø±ÙŠØ·Ø© Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯</header>

<div id="container">
  <div id="sidebar">
    <button id="toggleSidebar" onclick="toggleSidebar()">â›¶</button>
    <h2>Ø§Ù„Ù…Ø­Ø·Ø§Øª</h2>
    <ul id="stationList"></ul>
  </div>
  <div id="map"></div>
</div>

<div id="infoBar">Ø§Ø®ØªØ± Ù…Ø­Ø·Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ø³Ù…Ù‡Ø§ Ù‡Ù†Ø§</div>

<div id="assistant">
  <button id="toggleAssistant" onclick="toggleAssistant()">â›¶</button>
  <h3>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª</h3>
  <div id="messages"></div>
  <div id="input">
    <button id="micBtn" title="Ø§Ø¨Ø¯Ø£/Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ­Ø¯Ø«">ğŸ™ï¸</button>
    <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ... Ø£Ùˆ Ø§Ø¶ØºØ· ğŸ™ï¸ ÙˆØªÙƒÙ„Ù…">
    <button onclick="sendAssistantMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvoe3QqZfJbxNinSwPcgONdLDhyQF7OlQ&callback=initMap" async defer></script>

<script>
let map;
let infoWindow;
let markers = [];
let lastWelcomeTime = 0;
let welcomeCount = 0;

const stations = [
  { name: 'Ø±Ø¦Ø§Ø³Ø© Ø§Ù„Ø´Ø±ÙƒØ©', lat: 30.075775, lon: 31.31986388888889 },
  { name: 'Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ·Ù†ÙŠØ©', lat: 30.10302222222222, lon: 31.81430833333333 },
  { name: 'Ø®Ù„Ù Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ø´Ø±Ø·Ø©', lat: 30.0494630429643, lon: 31.44170636619374 },
  { name: 'FUELUP', lat: 30.075775, lon: 31.31986388888889 }
  // Ø£Ø¶Ù Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø­Ø·Ø§Øª Ù‡Ù†Ø§
];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 30.05, lng: 31.3 },
    zoom: 10
  });
  infoWindow = new google.maps.InfoWindow();
  
  stations.forEach(station => {
    const marker = new google.maps.Marker({
      position: { lat: station.lat, lng: station.lon },
      map: map,
      title: station.name
    });
    marker.addListener("click", () => showStationInfo(station));
    markers.push(marker);
    addToSidebar(station, marker);
  });

  new MarkerClusterer(map, markers, {
    imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
  });
}

function showStationInfo(station) {
  map.setCenter({ lat: station.lat, lng: station.lon });
  map.setZoom(15);
  infoWindow.setContent(`<strong>${station.name}</strong>`);
  infoWindow.setPosition({ lat: station.lat, lng: station.lon });
  infoWindow.open(map);
  const mapsLink = `https://www.google.com/maps/search/?api=1&query=${station.lat},${station.lon}`;
  document.getElementById("infoBar").innerHTML = `Ø§Ù„Ù…Ø­Ø·Ø©: ${station.name} | <a href="${mapsLink}" target="_blank">Ø§ÙØªØ­ ÙÙŠ Google Maps</a>`;
}

function addToSidebar(station, marker) {
  const li = document.createElement("li");
  li.innerText = station.name;
  li.addEventListener("click", () => {
    map.setCenter(marker.getPosition());
    map.setZoom(15);
    showStationInfo(station);
  });
  document.getElementById("stationList").appendChild(li);
}

function appendAssistantMessage(sender, text) {
  const msg = document.createElement("div");
  msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
  const panel = document.getElementById("messages");
  panel.appendChild(msg);
  panel.scrollTop = panel.scrollHeight;
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function findNearestStations(userLat, userLon, limit = 5) {
  return stations.map(st => ({ ...st, distance: getDistance(userLat, userLon, st.lat, st.lon) }))
                 .sort((a, b) => a.distance - b.distance)
                 .slice(0, limit);
}

function showNearestStations() {
  if (!navigator.geolocation) {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const userLat = pos.coords.latitude;
    const userLon = pos.coords.longitude;
    const nearest = findNearestStations(userLat, userLon, 5);

    map.setCenter({ lat: userLat, lng: userLon });
    map.setZoom(13);

    nearest.forEach(st => {
      new google.maps.Marker({
        position: { lat: st.lat, lng: st.lon },
        map: map,
        title: st.name,
        icon: { url: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png" }
      });
    });

    new google.maps.Marker({
      position: { lat: userLat, lng: userLon },
      map: map,
      title: "Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ",
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: "#00f",
        fillOpacity: 0.8,
        strokeColor: "#fff",
        strokeWeight: 2
      }
    });

    let msg = "Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¥Ù„ÙŠÙƒ:<br>";
    nearest.forEach(st => {
      msg += `<a href='https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}' target='_blank' class='clickable-station'>${st.name}</a> (Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ ${st.distance.toFixed(2)} ÙƒÙ…)<br>`;
    });
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", msg);
  }, err => {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS.");
  });
}

const voicePatterns = [
  /Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i,
  /ÙˆØ¯ÙŠÙ†ÙŠ/i,
  /ÙÙŠÙ† Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i,
  /Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ù‡ ÙÙŠÙ†/i,
  /Ø§ÙŠÙ† Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i,
  /Ù‡Ø§ØªÙ„ÙŠ Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©/i
];

function normalizeName(text) {
  if (!text) return "";
  let t = text.toLowerCase();

  t = t.replace(/[\u0617-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, "")
       .replace(/\u0640/g, "");
  const ar = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©";
  const lt = "0123456789";
  t = t.replace(/[Ù -Ù©]/g, d => lt[ar.indexOf(d)]);

  t = t.replace(/[Ø¢Ø£Ø¥Ù±]/g, "Ø§")
       .replace(/Ø©/g, "Ù‡")
       .replace(/Ù‰/g, "ÙŠ")
       .replace(/Ø¤/g, "Ùˆ")
       .replace(/Ø¦/g, "ÙŠ")
       .replace(/Ø¡/g, "")
       .replace(/Ú¯/g, "Ùƒ")
       .replace(/Ù¾/g, "Ø¨")
       .replace(/Ú˜/g, "Ø²")
       .replace(/Ú¤/g, "Ù");

  t = t.replace(/(^|\s)Ø£?Ù„Ù€?/g, "$1");
  t = t.replace(/\b(Ù…Ø­Ø·[Ù‡Ù‡]|Ù…Ø­Ø·Ø§Øª|Ø´Ø±ÙƒØ©|Ø§Ù„Ø´Ø±ÙƒÙ‡|Ø§Ù„Ø´Ø±ÙƒØ©|Ø£Ù„Ø´Ø±ÙƒØ©|ÙˆØ·Ù†ÙŠØ©|Ø§Ù„ÙˆØ·Ù†ÙŠÙ‡|Ø§Ù„ÙˆØ·Ù†ÙŠØ©)\b/g, "");

  const numMap = { "ÙˆØ§Ø­Ø¯": "1", "Ø§Ø«Ù†ÙŠÙ†": "2", "Ø«Ù„Ø§Ø«Ù‡": "3", "Ø§Ø±Ø¨Ø¹Ù‡": "4", "Ø®Ù…Ø³Ù‡": "5", "Ø³ØªÙ‡": "6", "Ø³Ø¨Ø¹Ù‡": "7", "ØªÙ…Ø§Ù†ÙŠÙ‡": "8", "ØªØ³Ø¹Ù‡": "9", "Ø¹Ø´Ø±Ù‡": "10" };
  Object.keys(numMap).forEach(k => { t = t.replace(new RegExp(`\\b${k}\\b`, "g"), numMap[k]); });

  t = t.replace(/[^\p{L}\p{N}]+/gu, "");
  return t;
}

function handleUserMessage(text) {
  const matched = voicePatterns.some(pat => pat.test(text));
  if (matched) {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ø«ÙˆØ§Ù†ÙŠ... Ø¨Ø¬Ù…Ø¹ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ ğŸ”");
    showNearestStations();
    return;
  }

  const matches = smartMatchAll(text);

  if (matches.length === 1) {
    const st = matches[0];
    map.setCenter({ lat: st.lat, lng: st.lon });
    map.setZoom(15);
    showStationInfo(st);
    const link = `https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}`;
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰: <a href='${link}' target='_blank' class='clickable-station'>${st.name}</a>`);
  } else if (matches.length > 1) {
    const msg = matches.map(m => {
      const link = `https://www.google.com/maps/search/?api=1&query=${m.lat},${m.lon}`;
      return `${m.name}: <a href='${link}' target='_blank' class='clickable-station'>Ø§ÙØªØ­</a>`;
    }).join("<br>");
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", `ÙˆØ¬Ø¯Øª Ø£ÙƒØ«Ø± Ù…Ù† Ù†ØªÙŠØ¬Ø©:<br>${msg}<br>Ù…Ù† ÙØ¶Ù„Ùƒ Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.`);
  } else {
    appendAssistantMessage("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯", "Ù„Ù… Ø£ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø©ØŒ Ø­Ø§ÙˆÙ„ ÙƒØªØ§Ø¨Ø©/Ù†Ø·Ù‚ Ø§Ù„Ø§Ø³Ù… Ø¨Ø´ÙƒÙ„ Ø£Ù‚Ø±Ø¨.");
  }
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('sidebarToggleBtn');
  sidebar.classList.toggle('collapsedSidebar');
  btn.style.display = sidebar.classList.contains('collapsedSidebar') ? 'block' : 'none';
}

function toggleAssistant() {
  const assistant = document.getElementById('assistant');
  const btn = document.getElementById('assistantToggleBtn');
  assistant.classList.toggle('collapsedAssistant');
  btn.style.display = assistant.classList.contains('collapsedAssistant') ? 'block' : 'none';
}

function sendAssistantMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;

  appendAssistantMessage("Ø£Ù†Øª", text);
  input.value = "";
  handleUserMessage(text);
}
</script>

</body>
</html>
