<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>خريطة محطات الوقود مع أوامر ذكية + Clustering + بحث صوتي</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #007BFF;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    #container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #sidebar {
      width: 260px;
      background: #fff;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 0.5rem;
    }
    #sidebar h2 { font-size: 1.2rem; margin-bottom: 0.5rem; }
    #sidebar ul { list-style: none; padding: 0; margin: 0; }
    #sidebar li {
      padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee;
    }
    #sidebar li:hover { background: #f0f0f0; }
    #map { flex: 1 1 auto; }
    #infoBar {
      background: #007BFF; color: #fff; padding: 0.5rem;
      text-align: center; flex-shrink: 0;
    }
    #assistant {
      position: fixed; bottom: 10px; left: 10px; width: 320px; max-width: 90%;
      background: #fff; border: 1px solid #ccc; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #assistant h3 {
      background: #007BFF; color: #fff; padding: 0.5rem; margin: 0;
      border-top-left-radius: 8px; border-top-right-radius: 8px;
    }
    #assistant #messages {
      height: 160px; overflow-y: auto; padding: 0.5rem;
      border-bottom: 1px solid #ddd; font-size: 0.9rem;
    }
    #assistant #input {
      display: flex; padding: 0.5rem; gap: 0.5rem; align-items: center;
    }
    #assistant input {
      flex: 1; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px;
    }
    #assistant button {
      padding: 0.4rem 0.6rem; background: #007BFF; color: #fff; border: none;
      border-radius: 4px; cursor: pointer;
    }
    .mic-btn {
      width: 40px; height: 40px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      background: #e9f2ff; color: #007BFF; border: 1px solid #bcd8ff;
      cursor: pointer; font-size: 18px;
    }
    .mic-btn.listening {
      background: #ffe9ec; color: #d1002f; border-color: #ffc0cb;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(209,0,47,0.4); }
      70% { box-shadow: 0 0 0 12px rgba(209,0,47,0); }
      100% { box-shadow: 0 0 0 0 rgba(209,0,47,0); }
    }
    .clickable-station { color: darkgreen; cursor: pointer; text-decoration: underline; }
    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #sidebar {
        width: 100%; max-height: 220px; border-left: none; border-top: 1px solid #ddd;
      }
      #assistant {
        left: 50%; transform: translateX(-50%); bottom: 10px; width: 95%; max-width: 360px;
      }
    }
  </style>
</head>
<body>

  <header>خريطة محطات الوقود</header>

  <div id="container">
    <div id="sidebar">
      <h2>المحطات</h2>
      <ul id="stationList"></ul>
    </div>
    <div id="map"></div>
  </div>

  <div id="infoBar">اختر محطة لرؤية اسمها هنا</div>

  <div id="assistant">
    <h3>مساعد المحطات</h3>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="userInput" placeholder="اكتب اسم المحطة أو أمر مثل: أقرب محطة">
      <button id="micBtn" class="mic-btn" title="بحث صوتي">🎤</button>
      <button id="sendBtn">إرسال</button>
    </div>
  </div>

  <!-- MarkerClusterer -->
  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

  <script>
    // ================== البيانات ==================
    const stations = [
      // TODO: الصق جميع محطاتك هنا (نفس المصفوفة الكبيرة التي أرسلتها)
      { name: 'رئاسة الشركة', lat: 30.075775, lon: 31.31986388888889 },
      { name: 'خلف أكاديمية الشرطة', lat: 30.0494630429643, lon: 31.44170636619374 },
      { name: 'الرحاب', lat: 30.04365008035782, lon: 31.49653604012123 }
    ];

    // ================== متغيرات عامة ==================
    let map, infoWindow;
    let markers = [];
    let nearestRequestCount = 0;

    // ================== تهيئة الخريطة ==================
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 30.05, lng: 31.3 },
        zoom: 10
      });
      infoWindow = new google.maps.InfoWindow();

      stations.forEach(st => {
        const marker = new google.maps.Marker({
          position: { lat: st.lat, lng: st.lon },
          map,
          title: st.name
        });
        marker.addListener("click", () => showStationInfo(st));
        markers.push(marker);

        const li = document.createElement("li");
        li.textContent = st.name;
        li.onclick = () => { showStationInfo(st); };
        document.getElementById("stationList").appendChild(li);
      });

      new MarkerClusterer(map, markers, {
        imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
      });
    }

    function showStationInfo(station) {
      map.setCenter({ lat: station.lat, lng: station.lon });
      map.setZoom(15);
      infoWindow.setContent(`<strong>${station.name}</strong>`);
      infoWindow.setPosition({ lat: station.lat, lng: station.lon });
      infoWindow.open(map);
      const mapsLink = `https://www.google.com/maps/search/?api=1&query=${station.lat},${station.lon}`;
      document.getElementById("infoBar").innerHTML =
        `المحطة: ${station.name} | <a href="${mapsLink}" target="_blank">افتح في Google Maps</a>`;
    }

    function appendAssistantMessage(sender, html) {
      const msg = document.createElement("div");
      msg.innerHTML = `<strong>${sender}:</strong> ${html}`;
      const box = document.getElementById("messages");
      box.appendChild(msg);
      box.scrollTop = box.scrollHeight;
    }

    // ================== مسافات ومطابقة ==================
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function findNearestStations(userLat, userLon, limit = 5) {
      return stations.map(st => ({ ...st, distance: getDistance(userLat, userLon, st.lat, st.lon) }))
                     .sort((a, b) => a.distance - b.distance)
                     .slice(0, limit);
    }

    function showNearestStations() {
      if (!navigator.geolocation) {
        appendAssistantMessage("المساعد", "المتصفح لا يدعم تحديد الموقع الجغرافي.");
        return;
      }

      nearestRequestCount++;
      if (nearestRequestCount > 4) {
        appendAssistantMessage("المساعد", "تم عرض المحطات مسبقًا، جرّب أمرًا آخر لو سمحت.");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;
        const nearest = findNearestStations(userLat, userLon, 5);

        map.setCenter({ lat: userLat, lng: userLon });
        map.setZoom(13);

        new google.maps.Marker({
          position: { lat: userLat, lng: userLon },
          map,
          title: "موقعك الحالي",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8, fillColor: "#00f", fillOpacity: 0.8,
            strokeColor: "#fff", strokeWeight: 2
          }
        });

        let msg = "أقرب المحطات إليك:<br>";
        nearest.forEach(st => {
          new google.maps.Marker({
            position: { lat: st.lat, lng: st.lon },
            map, title: st.name,
            icon: { url: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png" }
          });
          const link = `https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}`;
          msg += `<a href="${link}" target="_blank" class="clickable-station">${st.name}</a> (على بعد ${st.distance.toFixed(2)} كم)<br>`;
        });
        appendAssistantMessage("المساعد", msg);
      }, _ => {
        appendAssistantMessage("المساعد", "تعذر الحصول على موقعك. تأكد من تفعيل GPS وإذن الموقع.");
      });
    }

    // ================== تطبيع عربي ذكي (مُعزّز) ==================
    function normalizeName(text) {
      if (!text) return "";

      // Lower
      text = text.toLowerCase();

      // إزالة التشكيل والتطويل
      text = text
        .replace(/[\u0617-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, "") // تشكيل
        .replace(/\u0640/g, ""); // ـ

      // أرقام عربية -> لاتينية
      const arNums = "٠١٢٣٤٥٦٧٨٩";
      const ltNums = "0123456789";
      text = text.replace(/[٠-٩]/g, d => ltNums[arNums.indexOf(d)]);

      // توحيد الحروف والهمزات
      text = text
        .replace(/[آأإٱ]/g, "ا")
        .replace(/ة/g, "ه")
        .replace(/ى/g, "ي")
        .replace(/ؤ/g, "و")
        .replace(/ئ/g, "ي")
        .replace(/ء/g, "")
        .replace(/گ/g, "ك")
        .replace(/پ/g, "ب")
        .replace(/ژ/g, "ز")
        .replace(/ڤ/g, "ف");

      // إزالة "ال/أل/الـ" مهما كان شكلها
      text = text.replace(/(^|\s)أ?لـ?/g, "$1");

      // إزالة كلمات عامة لا تؤثر
      text = text
        .replace(/\b(محط[هه]|محطات)\b/g, "")
        .replace(/\b(شركة|الشركه|الشركة|ألشركة)\b/g, "")
        .replace(/\b(وطنية|الوطنيه|الوطنية)\b/g, "");

      // تحويل كلمات الأرقام (عربي/عامي/إنجليزي) → أرقام
      const numMap = {
        "واحد":"1","ون":"1","one":"1",
        "اتنين":"2","اثنين":"2","two":"2","تو":"2","تين":"2",
        "تلاته":"3","ثلاثه":"3","ثلاثة":"3","three":"3","ثري":"3","تلات":"3",
        "اربعه":"4","أربعه":"4","أربعة":"4","four":"4","فور":"4",
        "خمسه":"5","خمسة":"5","five":"5","فايف":"5",
        "سته":"6","ستة":"6","six":"6","سكس":"6",
        "سبعه":"7","سبعة":"7","seven":"7","سفن":"7",
        "تمانيه":"8","ثمانيه":"8","ثمانية":"8","eight":"8","ايت":"8",
        "تسعه":"9","تسعة":"9","nine":"9","ناين":"9",
        "عشره":"10","عشرة":"10","ten":"10","تن":"10"
      };
      Object.keys(numMap).forEach(k=>{
        text = text.replace(new RegExp(`\\b${k}\\b`, "g"), numMap[k]);
      });

      // أسماء الحروف المنطوقة الشائعة → حرف/لاتيني
      const letterMap = {
        "الف":"ا","ألف":"ا","الفا":"ا",
        "باء":"ب","بي":"ب","بيه":"ب",
        "تاء":"ت","تي":"ت","تيه":"ت",
        "جيم":"ج","جي":"ج",
        "دال":"د","دي":"د",
        "سين":"س","سي":"c","سيه":"c",
        "هاء":"ه","هيه":"ه",
        "واو":"و",
        "ياء":"ي","ياي":"ي","يي":"ي",
        "اكس":"x","إكس":"x",
        "زد":"z","زي":"z",
        // إنجليزية منطوقة
        "اي":"a","إي":"a","ايه":"a",
        "بي":"b","سي":"c","دي":"d","إف":"f","جي":"g","اتش":"h","اتشh":"h",
        "كي":"k","كيه":"k","ال":"l","ام":"m","ان":"n","او":"o","بي":"p","كيو":"q","ار":"r","اس":"s","تي":"t","في":"v","دبليو":"w","واي":"y"
      };
      Object.keys(letterMap).forEach(k=>{
        text = text.replace(new RegExp(`\\b${k}\\b`, "g"), letterMap[k]);
      });

      // إزالة كل ما ليس حرف/رقم
      text = text.replace(/[^\p{L}\p{N}]+/gu, "");

      return text;
    }

    function smartMatchAll(userText) {
      const userNorm = normalizeName(userText);
      if (!userNorm) return [];

      // تطابق مباشر/جزئي
      let results = stations.filter(s => normalizeName(s.name).includes(userNorm) || userNorm.includes(normalizeName(s.name)));
      if (results.length) return results;

      // fallback: مسافة تحرير صغيرة
      function editDistance(a, b) {
        const dp = Array.from({length: a.length + 1}, () => Array(b.length + 1).fill(0));
        for (let i=0;i<=a.length;i++) dp[i][0]=i;
        for (let j=0;j<=b.length;j++) dp[0][j]=j;
        for (let i=1;i<=a.length;i++){
          for (let j=1;j<=b.length;j++){
            const cost = a[i-1] === b[j-1] ? 0 : 1;
            dp[i][j] = Math.min(
              dp[i-1][j] + 1,
              dp[i][j-1] + 1,
              dp[i-1][j-1] + cost
            );
          }
        }
        return dp[a.length][b.length];
      }
      const MAX_DIST = 2;
      results = stations.filter(s => editDistance(normalizeName(s.name), userNorm) <= MAX_DIST);
      return results;
    }

    // ================== أوامر صوتية جاهزة ==================
    const voicePatterns = [
      /اقرب محطة/i, /وديني/i, /فين اقرب محطة/i, /اقرب محطه فين/i, /اين اقرب محطة/i, /هاتلي اقرب محطة/i
    ];

    function handleUserMessage(text) {
      // أوامر عامة
      if (voicePatterns.some(p => p.test(text))) {
        appendAssistantMessage("المساعد", "حاضر.. بجمع أقرب المحطات من موقعك 🔍");
        showNearestStations();
        return;
      }

      if (text.includes("تكبير")) { map.setZoom(map.getZoom() + 1); appendAssistantMessage("المساعد","تم تكبير الخريطة."); return; }
      if (text.includes("تصغير")) { map.setZoom(map.getZoom() - 1); appendAssistantMessage("المساعد","تم تصغير الخريطة."); return; }
      if (text.includes("إظهار كل المحطات")) { map.setZoom(10); map.setCenter({lat:30.05,lng:31.3}); appendAssistantMessage("المساعد","تم إظهار كل المحطات."); return; }

      // بحث بالأسماء بعد التطبيع الذكي
      const matches = smartMatchAll(text);
      if (matches.length === 1) {
        showStationInfo(matches[0]);
        const link = `https://www.google.com/maps/search/?api=1&query=${matches[0].lat},${matches[0].lon}`;
        appendAssistantMessage("المساعد", `تم تحديد ${matches[0].name} على الخريطة. <a href="${link}" target="_blank">ادخل إلى موقع المحطة</a>`);
      } else if (matches.length > 1) {
        const namesWithLinks = matches.map(m => {
          const link = `https://www.google.com/maps/search/?api=1&query=${m.lat},${m.lon}`;
          return `${m.name}: <a href="${link}" target="_blank">ادخل إلى موقع المحطة</a>`;
        }).join("<br>");
        appendAssistantMessage("المساعد", `وجدت المحطات التالية:<br>${namesWithLinks}<br>من فضلك اكتب اسم المحطة المطلوبة.`);
      } else {
        appendAssistantMessage("المساعد", "لم أتعرف على المحطة، حاول كتابة/نطق الاسم بشكل أقرب.");
      }
    }

    // ================== إرسال نصي ==================
    document.getElementById("sendBtn").addEventListener("click", () => {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;
      appendAssistantMessage("أنت", text);
      input.value = "";
      handleUserMessage(text);
    });

    // إرسال بالإنتر
    document.getElementById("userInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") document.getElementById("sendBtn").click();
    });

    // ================== بحث صوتي ==================
    (function setupVoiceSearch(){
      const micBtn = document.getElementById("micBtn");
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        micBtn.disabled = true;
        micBtn.title = "المتصفح لا يدعم البحث الصوتي";
        return;
      }

      const recog = new SpeechRecognition();
      recog.lang = "ar-EG";
      recog.interimResults = false;
      recog.maxAlternatives = 1;

      let listening = false;

      function start() {
        if (listening) return;
        listening = true;
        micBtn.classList.add("listening");
        micBtn.title = "جارٍ الاستماع... اضغط للإيقاف";
        try { recog.start(); } catch (_) {}
      }

      function stop() {
        listening = false;
        micBtn.classList.remove("listening");
        micBtn.title = "بحث صوتي";
        try { recog.stop(); } catch (_) {}
      }

      micBtn.addEventListener("click", () => {
        if (!listening) start(); else stop();
      });

      recog.onresult = (e) => {
        stop();
        const transcript = (e.results[0] && e.results[0][0] && e.results[0][0].transcript) ? e.results[0][0].transcript : "";
        if (transcript) {
          appendAssistantMessage("أنت (صوت)", transcript);
          handleUserMessage(transcript);
        } else {
          appendAssistantMessage("المساعد", "لم أسمع شيئًا واضحًا. حاول مرة أخرى.");
        }
      };

      recog.onerror = () => {
        stop();
        appendAssistantMessage("المساعد", "تعذر استخدام الميكروفون أو حدث خطأ في التعرف الصوتي.");
      };

      recog.onend = () => { stop(); };
    })();

    // اجعل initMap متاحة لسكربت خرائط جوجل
    window.initMap = initMap;
  </script>

  <!-- Google Maps (استبدل المفتاح بمفتاحك) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap" async defer></script>

  <div style="text-align: center; margin: 15px;">
    <button onclick="showNearestStations()" style="padding: 10px 20px; font-size: 16px; background-color: #007BFF; color: white; border: none; border-radius: 6px; cursor: pointer;">
      عرض أقرب المحطات
    </button>
  </div>
</body>
</html>
