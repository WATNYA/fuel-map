<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>خريطة محطات الوقود مع أوامر ذكية + Clustering</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #007BFF;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    #container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #sidebar {
      width: 250px;
      background: #fff;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 0.5rem;
    }
    #sidebar h2 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #sidebar li {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #sidebar li:hover {
      background: #f0f0f0;
    }
    #map {
      flex: 1 1 auto;
    }
    #infoBar {
      background: #007BFF;
      color: #fff;
      padding: 0.5rem;
      text-align: center;
      flex-shrink: 0;
    }
    #assistant {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 300px;
      max-width: 90%;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #assistant h3 {
      background: #007BFF;
      color: #fff;
      padding: 0.5rem;
      margin: 0;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    #assistant #messages {
      height: 150px;
      overflow-y: auto;
      padding: 0.5rem;
      border-bottom: 1px solid #ddd;
      font-size: 0.9rem;
    }
    #assistant #input {
      display: flex;
      padding: 0.5rem;
      gap: 0.5rem;
      align-items: center;
    }
    #assistant input {
      flex: 1;
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #assistant button {
      padding: 0.3rem 0.5rem;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #assistant #micBtn.listening { background:#dc3545; color:#fff; }

    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #sidebar {
        width: 100%;
        max-height: 200px;
        border-left: none;
        border-top: 1px solid #ddd;
      }
      #assistant {
        left: 50%;
        transform: translateX(-50%);
        bottom: 10px;
        width: 95%;
        max-width: 350px;
      }
    }
    #toggleSidebar, #toggleAssistant {
      position: absolute;
      top: 5px;
      left: 5px;
      z-index: 10;
      padding: 2px 5px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .collapsedSidebar { display: none !important; }
    .collapsedAssistant { display: none !important; }

    .clickable-station {
      color: darkgreen;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>

<button id="sidebarToggleBtn" onclick="toggleSidebar()" style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">📌</button>
<button id="assistantToggleBtn" onclick="toggleAssistant()" style="position: fixed; bottom: 10px; right: 10px; z-index: 9999; display: none;">💬</button>

<header>خريطة محطات الوقود</header>

<div id="container">
  <div id="sidebar">
    <button id="toggleSidebar" onclick="toggleSidebar()">⛶</button>
    <h2>المحطات</h2>
    <ul id="stationList"></ul>
  </div>
  <div id="map"></div>
</div>

<div id="infoBar">اختر محطة لرؤية اسمها هنا</div>

<div id="assistant">
  <button id="toggleAssistant" onclick="toggleAssistant()">⛶</button>
  <h3>مساعد المحطات</h3>
  <div id="messages"></div>
  <div id="input">
    <button id="micBtn" title="ابدأ/أوقف التحدث">🎙️</button>
    <input type="text" id="userInput" placeholder="اكتب طلبك... أو اضغط 🎙️ وتكلم">
    <button onclick="sendAssistantMessage()">إرسال</button>
  </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvoe3QqZfJbxNinSwPcgONdLDhyQF7OlQ&callback=initMap" async defer></script>

<script>
let map;
let infoWindow;
let markers = [];
let lastWelcomeTime = 0;
let welcomeCount = 0;

const stations = [
  { name: 'رئاسة الشركة', lat: 30.075775, lon: 31.31986388888889 },
  { name: 'مستودع وطنية', lat: 30.10302222222222, lon: 31.81430833333333 },
  { name: 'خلف أكاديمية الشرطة', lat: 30.0494630429643, lon: 31.44170636619374 },
  { name: 'FUELUP', lat: 30.075775, lon: 31.31986388888889 }
  // أضف المزيد من المحطات هنا
];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 30.05, lng: 31.3 },
    zoom: 10
  });
  infoWindow = new google.maps.InfoWindow();
  
  stations.forEach(station => {
    const marker = new google.maps.Marker({
      position: { lat: station.lat, lng: station.lon },
      map: map,
      title: station.name
    });
    marker.addListener("click", () => showStationInfo(station));
    markers.push(marker);
    addToSidebar(station, marker);
  });

  new MarkerClusterer(map, markers, {
    imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
  });
}

function showStationInfo(station) {
  map.setCenter({ lat: station.lat, lng: station.lon });
  map.setZoom(15);
  infoWindow.setContent(`<strong>${station.name}</strong>`);
  infoWindow.setPosition({ lat: station.lat, lng: station.lon });
  infoWindow.open(map);
  const mapsLink = `https://www.google.com/maps/search/?api=1&query=${station.lat},${station.lon}`;
  document.getElementById("infoBar").innerHTML = `المحطة: ${station.name} | <a href="${mapsLink}" target="_blank">افتح في Google Maps</a>`;
}

function addToSidebar(station, marker) {
  const li = document.createElement("li");
  li.innerText = station.name;
  li.addEventListener("click", () => {
    map.setCenter(marker.getPosition());
    map.setZoom(15);
    showStationInfo(station);
  });
  document.getElementById("stationList").appendChild(li);
}

function appendAssistantMessage(sender, text) {
  const msg = document.createElement("div");
  msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
  const panel = document.getElementById("messages");
  panel.appendChild(msg);
  panel.scrollTop = panel.scrollHeight;
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function findNearestStations(userLat, userLon, limit = 5) {
  return stations.map(st => ({ ...st, distance: getDistance(userLat, userLon, st.lat, st.lon) }))
                 .sort((a, b) => a.distance - b.distance)
                 .slice(0, limit);
}

function showNearestStations() {
  if (!navigator.geolocation) {
    appendAssistantMessage("المساعد", "المتصفح لا يدعم تحديد الموقع.");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const userLat = pos.coords.latitude;
    const userLon = pos.coords.longitude;
    const nearest = findNearestStations(userLat, userLon, 5);

    map.setCenter({ lat: userLat, lng: userLon });
    map.setZoom(13);

    nearest.forEach(st => {
      new google.maps.Marker({
        position: { lat: st.lat, lng: st.lon },
        map: map,
        title: st.name,
        icon: { url: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png" }
      });
    });

    new google.maps.Marker({
      position: { lat: userLat, lng: userLon },
      map: map,
      title: "موقعك الحالي",
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: "#00f",
        fillOpacity: 0.8,
        strokeColor: "#fff",
        strokeWeight: 2
      }
    });

    let msg = "أقرب المحطات إليك:<br>";
    nearest.forEach(st => {
      msg += `<a href='https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}' target='_blank' class='clickable-station'>${st.name}</a> (على بعد ${st.distance.toFixed(2)} كم)<br>`;
    });
    appendAssistantMessage("المساعد", msg);
  }, err => {
    appendAssistantMessage("المساعد", "تعذر الحصول على موقعك. تأكد من تفعيل GPS.");
  });
}

const voicePatterns = [
  /اقرب محطة/i,
  /وديني/i,
  /فين اقرب محطة/i,
  /اقرب محطه فين/i,
  /اين اقرب محطة/i,
  /هاتلي اقرب محطة/i
];

function normalizeName(text) {
  if (!text) return "";
  let t = text.toLowerCase();

  t = t.replace(/[\u0617-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, "")
       .replace(/\u0640/g, "");
  const ar = "٠١٢٣٤٥٦٧٨٩";
  const lt = "0123456789";
  t = t.replace(/[٠-٩]/g, d => lt[ar.indexOf(d)]);

  t = t.replace(/[آأإٱ]/g, "ا")
       .replace(/ة/g, "ه")
       .replace(/ى/g, "ي")
       .replace(/ؤ/g, "و")
       .replace(/ئ/g, "ي")
       .replace(/ء/g, "")
       .replace(/گ/g, "ك")
       .replace(/پ/g, "ب")
       .replace(/ژ/g, "ز")
       .replace(/ڤ/g, "ف");

  t = t.replace(/(^|\s)أ?لـ?/g, "$1");
  t = t.replace(/\b(محط[هه]|محطات|شركة|الشركه|الشركة|ألشركة|وطنية|الوطنيه|الوطنية)\b/g, "");

  const numMap = { "واحد": "1", "اثنين": "2", "ثلاثه": "3", "اربعه": "4", "خمسه": "5", "سته": "6", "سبعه": "7", "تمانيه": "8", "تسعه": "9", "عشره": "10" };
  Object.keys(numMap).forEach(k => { t = t.replace(new RegExp(`\\b${k}\\b`, "g"), numMap[k]); });

  t = t.replace(/[^\p{L}\p{N}]+/gu, "");
  return t;
}

function handleUserMessage(text) {
  const matched = voicePatterns.some(pat => pat.test(text));
  if (matched) {
    appendAssistantMessage("المساعد", "ثواني... بجمع أقرب المحطات من موقعك 🔍");
    showNearestStations();
    return;
  }

  const matches = smartMatchAll(text);

  if (matches.length === 1) {
    const st = matches[0];
    map.setCenter({ lat: st.lat, lng: st.lon });
    map.setZoom(15);
    showStationInfo(st);
    const link = `https://www.google.com/maps/search/?api=1&query=${st.lat},${st.lon}`;
    appendAssistantMessage("المساعد", `تم العثور على: <a href='${link}' target='_blank' class='clickable-station'>${st.name}</a>`);
  } else if (matches.length > 1) {
    const msg = matches.map(m => {
      const link = `https://www.google.com/maps/search/?api=1&query=${m.lat},${m.lon}`;
      return `${m.name}: <a href='${link}' target='_blank' class='clickable-station'>افتح</a>`;
    }).join("<br>");
    appendAssistantMessage("المساعد", `وجدت أكثر من نتيجة:<br>${msg}<br>من فضلك حدّد الاسم المطلوب.`);
  } else {
    appendAssistantMessage("المساعد", "لم أتعرف على المحطة، حاول كتابة/نطق الاسم بشكل أقرب.");
  }
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('sidebarToggleBtn');
  sidebar.classList.toggle('collapsedSidebar');
  btn.style.display = sidebar.classList.contains('collapsedSidebar') ? 'block' : 'none';
}

function toggleAssistant() {
  const assistant = document.getElementById('assistant');
  const btn = document.getElementById('assistantToggleBtn');
  assistant.classList.toggle('collapsedAssistant');
  btn.style.display = assistant.classList.contains('collapsedAssistant') ? 'block' : 'none';
}

function sendAssistantMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;

  appendAssistantMessage("أنت", text);
  input.value = "";
  handleUserMessage(text);
}
</script>

</body>
</html>
